<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMALIA POS - VERIFIED STABLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; outline: none; width: 100%; }
        .nav-btn { flex: 1; padding: 10px; font-size: 10px; font-weight: 800; color: #64748b; text-align: center; cursor: pointer; }
        .nav-btn.active { color: #3b82f6; border-top: 2px solid #3b82f6; }
        #dropdownSearch { position: absolute; width: 100%; top: 60px; z-index: 100; background: #1e293b; border-radius: 12px; max-height: 45vh; overflow-y: auto; border: 1px solid #3b82f6; }
    </style>
</head>
<body>

    <div id="login-page" class="fixed inset-0 z-[1000] bg-[#020617] flex items-center justify-center p-6">
        <div class="glass-card p-8 rounded-3xl w-full max-w-xs text-center">
            <h1 class="text-3xl font-black text-blue-500 mb-2 italic">AMALIA</h1>
            <p class="text-[10px] mb-6 opacity-50 uppercase tracking-widest">Point of Sale System</p>
            <input type="text" id="inNamaUser" placeholder="NAMA PETUGAS" class="mb-4 uppercase font-bold text-center">
            <button onclick="login()" class="w-full bg-blue-600 h-12 rounded-xl font-bold uppercase">Masuk Kasir</button>
        </div>
    </div>

    <header class="p-4 glass-card flex justify-between items-center">
        <h1 class="font-black italic text-blue-500">AMALIA STORE</h1>
        <div id="user-display" class="text-[10px] font-bold uppercase text-slate-400"></div>
    </header>

    <main class="flex-grow overflow-hidden relative">
        <section id="sec-kasir" class="p-3 h-full flex flex-col">
            <div class="relative mb-3">
                <input type="text" id="inCari" oninput="cariBarang(this.value)" placeholder="Cari Nama Produk..." class="h-14 font-bold uppercase">
                <div id="dropdownSearch" class="hidden"></div>
            </div>
            <div class="flex-grow glass-card rounded-xl overflow-y-auto mb-3">
                <table class="w-full text-xs">
                    <thead class="bg-slate-800 sticky top-0">
                        <tr><th class="p-3 text-left">NAMA BARANG</th><th class="p-3 text-center">QTY</th><th class="p-3 text-right">SUBTOTAL</th></tr>
                    </thead>
                    <tbody id="tabelKasir"></tbody>
                </table>
            </div>
            <div class="glass-card p-4 rounded-xl space-y-3">
                <div class="flex justify-between items-end">
                    <div><p class="text-[10px] font-bold opacity-50 uppercase">Total Bayar</p><h1 id="totalHarga" class="text-3xl font-black">Rp 0</h1></div>
                    <div class="text-right"><p class="text-[10px] font-bold opacity-50 uppercase">Kembali</p><h1 id="kembalian" class="text-xl font-black text-green-400">Rp 0</h1></div>
                </div>
                <input type="number" id="bayarTunai" oninput="hitung()" placeholder="JUMLAH PEMBAYARAN" class="h-12 text-lg font-bold">
                <button onclick="simpanTrx()" class="w-full bg-blue-600 h-14 rounded-xl font-black text-lg uppercase shadow-xl">Simpan Transaksi</button>
            </div>
        </section>

        <section id="sec-data" class="hidden p-4 h-full overflow-y-auto pb-20">
            <div class="grid grid-cols-2 gap-2 mb-6 text-center">
                <div class="glass-card p-3 rounded-lg"><p class="text-[8px] font-bold opacity-50 uppercase">Omzet Hari Ini</p><h2 id="lap-omzet" class="font-black text-blue-400">Rp 0</h2></div>
                <div class="glass-card p-3 rounded-lg"><p class="text-[8px] font-bold opacity-50 uppercase">Total Trx</p><h2 id="lap-count" class="font-black">0</h2></div>
            </div>
            <h2 class="text-xs font-bold mb-3 text-blue-400 uppercase tracking-widest">Riwayat Penjualan</h2>
            <div id="history-list" class="space-y-2"></div>
        </section>
    </main>

    <nav class="h-16 glass-card flex items-center border-t border-white/5">
        <div onclick="tab('kasir')" id="nav-kasir" class="nav-btn active">ðŸ›’<br>KASIR</div>
        <div onclick="tab('data')" id="nav-data" class="nav-btn">ðŸ“Š<br>LAPORAN</div>
    </nav>

    <script>
        const config = {
            apiKey: "AIzaSyBhrN6vuBzuxwFgPI-iXJky6ErDz8auclY",
            authDomain: "toko4malia.firebaseapp.com",
            projectId: "toko4malia",
            storageBucket: "toko4malia.firebasestorage.app",
            messagingSenderId: "1053922856540",
            appId: "1:1053922856540:web:34f5e6de7d5538b1e66099"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();

        let dataBarang = [], keranjang = [], user = '';

        // JAMINAN HARGA: Membersihkan data kotor dari database
        function paksaAngka(item) {
            // Cek semua kemungkinan field harga
            let hRaw = item.ecer || item.harga || item.harga_jual || 0;
            // Buang semua titik, koma, atau huruf. Sisakan angka murni.
            let hClean = hRaw.toString().replace(/\D/g, '');
            return parseInt(hClean) || 0;
        }

        function formatIDR(n) {
            return "Rp " + (Number(n) || 0).toLocaleString('id-ID');
        }

        function login() {
            user = document.getElementById('inNamaUser').value;
            if(!user) return alert("Silakan isi nama petugas!");
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('user-display').innerText = user;
            mulai();
        }

        function mulai() {
            db.collection("barang").onSnapshot(s => {
                dataBarang = s.docs.map(d => ({ id: d.id, ...d.data() }));
            });
            db.collection("transaksi").orderBy("waktu","desc").limit(30).onSnapshot(s => {
                const trx = s.docs.map(d => d.data());
                document.getElementById('lap-count').innerText = s.size;
                document.getElementById('lap-omzet').innerText = formatIDR(trx.reduce((a,b)=>a+(Number(b.total)||0),0));
                document.getElementById('history-list').innerHTML = trx.map(t => `
                    <div class="glass-card p-3 rounded-lg flex justify-between items-center text-xs">
                        <div><p class="font-bold opacity-40">${new Date(t.waktu).toLocaleTimeString()}</p><p class="uppercase font-black">TRX-DONE</p></div>
                        <span class="font-black text-blue-400">${formatIDR(t.total)}</span>
                    </div>
                `).join('');
            });
        }

        function tab(id) {
            document.getElementById('sec-kasir').classList.toggle('hidden', id !== 'kasir');
            document.getElementById('sec-data').classList.toggle('hidden', id !== 'data');
            document.getElementById('nav-kasir').classList.toggle('active', id === 'kasir');
            document.getElementById('nav-data').classList.toggle('active', id === 'data');
        }

        function cariBarang(q) {
            const d = document.getElementById('dropdownSearch');
            if(!q) return d.classList.add('hidden');
            const h = dataBarang.filter(b => b.nama.toLowerCase().includes(q.toLowerCase()));
            d.innerHTML = h.map(b => {
                const hargaFix = paksaAngka(b);
                return `
                <div onclick="add('${b.id}')" class="p-4 border-b border-white/5 flex justify-between items-center active:bg-blue-600">
                    <div><p class="font-bold uppercase">${b.nama}</p><p class="text-blue-400 font-bold">${formatIDR(hargaFix)}</p></div>
                    <div class="text-[10px] bg-blue-600 px-2 py-1 rounded font-bold">STOK: ${b.stok||0}</div>
                </div>`;
            }).join('');
            d.classList.remove('hidden');
        }

        function add(id) {
            const b = dataBarang.find(x => x.id === id);
            const harga = paksaAngka(b);
            const ada = keranjang.find(k => k.id === id);
            if(ada) ada.qty++; else keranjang.push({id: b.id, nama: b.nama, ecer: harga, qty: 1});
            document.getElementById('inCari').value = '';
            document.getElementById('dropdownSearch').classList.add('hidden');
            render();
        }

        function render() {
            let total = 0;
            document.getElementById('tabelKasir').innerHTML = keranjang.map((k,i) => {
                const sub = k.qty * k.ecer;
                total += sub;
                return `<tr class="border-b border-white/5"><td class="p-3 uppercase font-bold">${k.nama}<br><small class="opacity-40">@${formatIDR(k.ecer)}</small></td><td class="p-3 text-center font-bold">${k.qty}</td><td class="p-3 text-right font-bold">${formatIDR(sub)}</td></tr>`;
            }).join('');
            document.getElementById('totalHarga').innerText = formatIDR(total);
            hitung();
        }

        function hitung() {
            const total = parseInt(document.getElementById('totalHarga').innerText.replace(/\D/g,'')) || 0;
            const bayar = parseInt(document.getElementById('bayarTunai').value) || 0;
            document.getElementById('kembalian').innerText = formatIDR(Math.max(0, bayar - total));
        }

        async function simpanTrx() {
            const total = parseInt(document.getElementById('totalHarga').innerText.replace(/\D/g,'')) || 0;
            const bayar = parseInt(document.getElementById('bayarTunai').value) || 0;
            if(total <= 0) return alert("Keranjang masih kosong!");
            if(bayar < total) return alert("Uang pembayaran kurang!");
            try {
                await db.collection("transaksi").add({ waktu: Date.now(), items: keranjang, total: total, kasir: user });
                alert("Transaksi Berhasil Disimpan!");
                keranjang = []; document.getElementById('bayarTunai').value = ''; render();
            } catch(e) { alert("Gagal menyimpan ke database!"); }
        }
    </script>
</body>
</html>
