<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMALIA POS PRO - Multi Device</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #3b82f6; --bg: #020617; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #f8fafc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; margin: 0; }
        
        /* Glass Effect */
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .font-mono-price { font-family: 'JetBrains Mono', monospace; }
        
        /* Scrollbar */
        .custom-scroll { overflow-y: auto !important; scrollbar-width: thin; scrollbar-color: rgba(59, 130, 246, 0.3) transparent; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.3); border-radius: 10px; }

        /* Badge Stok */
        .badge-stok { background: #facc15; color: #000; padding: 4px 10px; border-radius: 8px; font-weight: 800; font-size: 12px; display: inline-block; }
        .badge-stok-low { background: #ef4444; color: white; }

        /* Responsive Navigation Buttons */
        .nav-btn { transition: 0.3s; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); color: #94a3b8; font-weight: 700; border-radius: 12px; white-space: nowrap; }
        .nav-btn.active { background: linear-gradient(135deg, rgba(59, 130, 246, 0.5), rgba(59, 130, 246, 0.2)); color: white; border: 1px solid rgba(59, 130, 246, 0.5); }

        /* Toast Center */
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5); z-index: 9999; opacity: 0; visibility: hidden; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 80%; max-width: 320px; }
        #toast.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }

        /* Utility for Mobile Touch */
        input, button { touch-action: manipulation; }
        input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1); color: white; outline: none; }
        
        /* Layout Adaptif */
        #main-container { flex-direction: row; }
        @media (max-width: 1024px) {
            #main-container { flex-direction: column; overflow-y: auto; }
            #side-panel { width: 100% !important; border-left: none !important; border-top: 1px solid rgba(255,255,255,0.1); position: sticky; bottom: 0; z-index: 40; background: #020617; }
            header { padding: 10px 15px !important; }
            .section-page { height: auto !important; overflow: visible !important; }
            body { overflow-y: auto; }
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 58mm; color: black; }
        }
    </style>
</head>
<body>

    <div id="print-area" class="hidden font-mono text-[10px] w-[58mm]"></div>

    <div id="toast">
        <div id="toast-inner" class="glass-card px-6 py-8 rounded-[30px] border-t-4 border-blue-500 shadow-2xl text-center">
            <div id="toast-icon" class="text-3xl mb-2"></div>
            <div id="toast-text" class="text-sm font-black uppercase text-white"></div>
        </div>
    </div>

    <div id="modal-print-confirm" class="fixed inset-0 z-[1010] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-xs text-center border-white/10">
            <h2 class="text-xl font-black text-white uppercase mb-4">BERHASIL!</h2>
            <p class="text-slate-400 font-bold text-xs mb-6 uppercase">Cetak Struk?</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="handlePrintDecision(true)" class="bg-blue-600 py-4 rounded-2xl font-black uppercase text-sm">YA</button>
                <button onclick="handlePrintDecision(false)" class="bg-white/5 py-4 rounded-2xl font-black uppercase text-sm">TIDAK</button>
            </div>
        </div>
    </div>

    <div id="login-page" class="fixed inset-0 z-[1000] bg-[#020617] flex items-center justify-center p-4">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-xs text-center">
            <h1 class="text-4xl font-black italic text-blue-500 mb-1">AMALIA</h1>
            <p class="text-[8px] font-bold text-slate-500 uppercase tracking-[0.3em] mb-8">Point of Sale</p>
            <input type="text" id="inNamaUser" placeholder="NAMA PETUGAS" class="w-full p-4 rounded-2xl text-center font-black uppercase mb-4 text-sm">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="attemptLogin('Kasir')" class="bg-white/5 p-4 rounded-xl font-bold text-[10px] uppercase">KASIR</button>
                <button onclick="attemptLogin('Admin')" class="bg-blue-600 p-4 rounded-xl font-bold text-[10px] uppercase">ADMIN</button>
            </div>
        </div>
    </div>

    <header class="p-4 px-6 flex flex-wrap justify-between items-center glass-card border-b border-white/5 shrink-0 z-50 gap-4">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-black italic text-white">A</div>
            <h1 class="text-lg font-black italic text-white">AMALIA</h1>
        </div>
        <nav id="main-nav" class="hidden flex gap-2 overflow-x-auto pb-1 no-scrollbar">
            <button id="nav-kasir" onclick="showSection('kasir')" class="nav-btn px-4 py-1.5 text-[10px] active uppercase">Kasir</button>
            <button id="nav-history" onclick="showSection('history')" class="nav-btn px-4 py-1.5 text-[10px] uppercase">History</button>
            <button id="nav-laporan" onclick="showSection('laporan')" class="nav-btn px-4 py-1.5 text-[10px] uppercase">Laporan</button>
            <button id="nav-admin" onclick="showSection('admin')" class="nav-btn px-4 py-1.5 text-[10px] hidden uppercase !text-blue-400">Admin</button>
        </nav>
        <div class="flex items-center gap-3">
            <div class="text-right hidden sm:block">
                <p id="user-info" class="text-[10px] font-black uppercase text-white leading-none"></p>
                <p id="role-info" class="text-[8px] font-bold text-blue-500 uppercase"></p>
            </div>
            <button onclick="location.reload()" class="bg-red-500/10 text-red-500 p-2 rounded-lg font-bold text-sm">‚úï</button>
        </div>
    </header>

    <main id="main-container" class="flex flex-grow overflow-hidden">
        <div id="sec-kasir" class="section-page w-full flex flex-col lg:flex-row overflow-hidden">
            <div class="flex-grow p-4 lg:p-6 flex flex-col overflow-hidden">
                <div class="relative mb-4">
                    <input type="text" id="inCari" oninput="searchBarang(this.value)" placeholder="Cari Produk..." class="w-full p-4 rounded-2xl text-lg font-bold">
                    <div id="dropdownSearch" class="absolute top-full left-0 right-0 glass-card rounded-2xl mt-2 z-[100] max-h-[300px] overflow-y-auto custom-scroll hidden shadow-2xl"></div>
                </div>
                <div class="glass-card rounded-[25px] flex-grow flex flex-col overflow-hidden min-h-[300px]">
                    <div class="overflow-y-auto custom-scroll flex-grow">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-900/50 sticky top-0 font-bold uppercase text-slate-500">
                                <tr><th class="p-4">Item</th><th class="p-4">Qty</th><th class="p-4 text-right">Sub</th><th class="p-4"></th></tr>
                            </thead>
                            <tbody id="tabelKasir" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="side-panel" class="w-full lg:w-80 p-4 lg:p-6 glass-card border-l border-white/5 flex flex-col gap-3 shrink-0">
                <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-4 rounded-2xl shadow-lg">
                    <p class="text-[9px] font-bold uppercase opacity-70">Total Akhir</p>
                    <h1 id="totalBelanja" class="text-2xl font-black font-mono-price">Rp 0</h1>
                </div>
                
                <div class="grid grid-cols-2 lg:grid-cols-1 gap-3">
                    <div class="p-3 bg-white/5 rounded-xl border border-white/10">
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Diskon</label>
                        <input type="text" id="diskonManual" oninput="formatMoneyInput(this); renderCart()" class="w-full bg-transparent text-sm font-bold text-orange-400" placeholder="0">
                    </div>
                    <div class="p-3 bg-white/5 rounded-xl border border-white/10">
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Tunai (F8)</label>
                        <input type="text" id="bayarTunai" oninput="formatMoneyInput(this); hitungKembali()" class="w-full bg-transparent text-sm font-black text-blue-400" placeholder="0">
                    </div>
                </div>

                <div class="p-3 bg-slate-900/50 rounded-xl flex justify-between items-center">
                    <span class="text-[9px] text-slate-500 font-bold uppercase">Kembali</span>
                    <span id="kembalianText" class="text-sm font-black text-green-400 font-mono-price">Rp 0</span>
                </div>
                <button onclick="prosesBayar()" class="w-full bg-blue-600 py-4 rounded-xl font-black text-sm uppercase transition-all active:scale-95 shadow-lg shadow-blue-500/20">Bayar Sekarang</button>
            </div>
        </div>

        <div id="sec-history" class="section-page hidden w-full overflow-y-auto custom-scroll p-4 lg:p-8">
            <div class="max-w-3xl mx-auto space-y-4" id="history-list"></div>
        </div>

        <div id="sec-laporan" class="section-page hidden w-full overflow-y-auto custom-scroll p-4 lg:p-8">
            <div class="max-w-4xl mx-auto space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <div class="glass-card p-5 rounded-2xl sm:col-span-2 border-l-4 border-blue-500">
                        <p class="text-[9px] text-blue-400 font-black uppercase">Omzet</p>
                        <h1 id="omzet-all" class="text-2xl font-black font-mono-price">Rp 0</h1>
                    </div>
                    <div class="glass-card p-5 rounded-2xl text-center">
                        <p class="text-[9px] text-slate-500 font-black uppercase">Transaksi</p>
                        <h1 id="all-count-total" class="text-2xl font-black">0</h1>
                    </div>
                </div>
                <div class="glass-card p-4 rounded-2xl flex flex-wrap gap-2 items-center justify-between">
                    <div class="flex gap-2 w-full sm:w-auto">
                        <input type="date" id="pick-day" onchange="filterLaporan()" class="p-2 rounded-lg text-[10px] font-bold bg-white/5 w-1/2">
                        <input type="month" id="pick-month" onchange="filterLaporan()" class="p-2 rounded-lg text-[10px] font-bold bg-white/5 w-1/2">
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] text-yellow-500 uppercase font-bold">Filter: <span id="lap-count" class="text-white">0</span> Trx</p>
                        <h2 id="lap-omzet" class="text-lg font-black font-mono-price">Rp 0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-admin" class="section-page hidden w-full p-4 lg:p-8 flex flex-col lg:flex-row gap-6 overflow-y-auto lg:overflow-hidden">
            <div class="w-full lg:w-72 shrink-0">
                <div class="glass-card p-5 rounded-3xl">
                    <h2 class="text-sm font-black uppercase mb-4 italic">Tambah Stok</h2>
                    <div class="space-y-2" id="admForm">
                        <input type="text" id="admNama" placeholder="NAMA BARANG" class="w-full p-3 rounded-xl text-[10px] font-black uppercase">
                        <input type="text" id="admEcer" oninput="formatMoneyInput(this)" placeholder="HARGA ECER" class="w-full p-3 rounded-xl text-xs font-mono-price">
                        <input type="text" id="admGrosir" oninput="formatMoneyInput(this)" placeholder="HARGA BOX" class="w-full p-3 rounded-xl text-xs font-mono-price">
                        <input type="number" id="admStok" placeholder="STOK" class="w-full p-3 rounded-xl text-xs font-bold">
                        <button onclick="simpanBarang()" class="w-full bg-blue-600 py-3 rounded-xl font-bold uppercase text-[10px]">Simpan</button>
                    </div>
                </div>
            </div>
            <div class="flex-grow glass-card rounded-3xl flex flex-col overflow-hidden min-h-[400px]">
                <div class="p-3 border-b border-white/5">
                    <input type="text" oninput="renderAdminTable(this.value)" placeholder="CARI DATABASE..." class="w-full p-2 rounded-lg text-[10px] font-bold uppercase">
                </div>
                <div class="flex-grow overflow-x-auto custom-scroll">
                    <table class="w-full text-left text-[10px]">
                        <thead class="bg-slate-900/50 sticky top-0 text-slate-500 font-bold uppercase">
                            <tr><th class="p-4">Nama</th><th class="p-4">Ecer</th><th class="p-4">Box</th><th class="p-4">Stok</th><th class="p-4"></th></tr>
                        </thead>
                        <tbody id="tabelAdmin" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-pass" class="fixed inset-0 z-[1001] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-card p-8 rounded-[35px] w-full max-w-xs text-center border-white/10">
            <h2 class="text-xs font-bold mb-4 text-white uppercase tracking-widest">PIN Admin</h2>
            <input type="password" id="admin-pass-input" class="w-full p-4 rounded-xl mb-4 text-center text-2xl font-bold tracking-[0.5em]">
            <button onclick="checkAdminPass()" class="w-full bg-blue-600 py-3 rounded-xl font-bold uppercase text-xs">Akses</button>
            <button onclick="closePassModal()" class="mt-4 text-[8px] text-slate-500 font-bold uppercase">Kembali</button>
        </div>
    </div>

    <div id="modal-edit" class="fixed inset-0 z-[1005] bg-black/80 hidden items-center justify-center p-6 backdrop-blur-md">
        <div class="glass-card p-6 rounded-3xl w-full max-w-sm">
            <h2 class="text-sm font-black mb-4 text-blue-400 uppercase italic">Edit Item</h2>
            <div class="space-y-3">
                <input type="text" id="editNama" class="w-full p-3 rounded-xl font-bold uppercase text-xs">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="editEcer" oninput="formatMoneyInput(this)" class="p-3 rounded-xl text-xs font-mono-price" placeholder="Ecer">
                    <input type="text" id="editGrosir" oninput="formatMoneyInput(this)" class="p-3 rounded-xl text-xs font-mono-price" placeholder="Box">
                </div>
                <input type="number" id="editStok" class="w-full p-3 rounded-xl font-bold text-xs" placeholder="Stok">
                <button onclick="updateBarang()" class="w-full bg-blue-600 py-3 rounded-xl font-bold text-xs uppercase">Simpan</button>
                <button onclick="closeEditModal()" class="w-full py-1 text-slate-500 text-[9px] uppercase font-bold">Batal</button>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG (Tetap Sama)
        const config = {
            apiKey: "AIzaSyBhrN6vuBzuxwFgPI-iXJky6ErDz8auclY",
            authDomain: "toko4malia.firebaseapp.com",
            projectId: "toko4malia",
            storageBucket: "toko4malia.firebasestorage.app",
            messagingSenderId: "1053922856540",
            appId: "1:1053922856540:web:34f5e6de7d5538b1e66099"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();

        let dataBarang = [], dataTransaksi = [], keranjang = [], userAktif = '', userRole = '', editingId = null, lastTransactionId = null;

        const formatIDR = (n) => new Intl.NumberFormat('id-ID').format(n || 0);
        const toNum = (s) => parseInt(s?.toString().replace(/[^0-9]/g, '')) || 0;

        function formatMoneyInput(el) {
            let v = toNum(el.value);
            el.value = v === 0 ? "" : formatIDR(v);
        }

        function toast(msg, type = 'blue') {
            const t = document.getElementById('toast');
            const txt = document.getElementById('toast-text');
            const ico = document.getElementById('toast-icon');
            const inner = document.getElementById('toast-inner');
            inner.style.borderColor = type === 'red' ? '#ef4444' : '#3b82f6';
            ico.innerHTML = type === 'red' ? '‚ö†Ô∏è' : '‚úÖ';
            txt.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // --- AUTH ---
        function attemptLogin(role) {
            const name = document.getElementById('inNamaUser').value;
            if(!name) return toast("Isi Nama!", "red");
            if(role === 'Admin') document.getElementById('modal-pass').classList.replace('hidden', 'flex');
            else loginSuccess(name, 'Kasir');
        }

        function checkAdminPass() {
            if(document.getElementById('admin-pass-input').value === '1212') {
                loginSuccess(document.getElementById('inNamaUser').value, 'Admin');
                closePassModal();
            } else { toast("PIN SALAH!", "red"); }
        }

        function loginSuccess(name, role) {
            userAktif = name; userRole = role;
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-nav').classList.replace('hidden', 'flex');
            document.getElementById('user-info').innerText = name;
            document.getElementById('role-info').innerText = role;
            if(role === 'Admin') document.getElementById('nav-admin').classList.remove('hidden');
            showSection('kasir'); syncData();
        }

        function closePassModal() { document.getElementById('modal-pass').classList.replace('flex', 'hidden'); }

        function syncData() {
            db.collection("barang").onSnapshot(snap => {
                dataBarang = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAdminTable();
            });
            db.collection("transaksi").orderBy("waktu", "desc").onSnapshot(snap => {
                dataTransaksi = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderHistory(); updateLaporan();
            });
        }

        function showSection(id) {
            document.querySelectorAll('.section-page').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const b = document.getElementById('nav-' + id);
            if(b) b.classList.add('active');
            window.scrollTo(0,0);
        }

        // --- KASIR ---
        function searchBarang(val) {
            const list = document.getElementById('dropdownSearch');
            if(!val) return list.classList.add('hidden');
            const res = dataBarang.filter(b => b.nama.toLowerCase().includes(val.toLowerCase()));
            list.innerHTML = res.map(b => `
                <div onclick="addToCart('${b.id}')" class="p-4 border-b border-white/5 cursor-pointer hover:bg-white/10 flex justify-between items-center">
                    <div><p class="font-black text-white uppercase text-[10px]">${b.nama}</p><div><span class="badge-stok ${b.stok < 5 ? 'badge-stok-low' : ''}" style="font-size:8px; padding:2px 5px;">STOK: ${b.stok}</span></div></div>
                    <p class="font-mono-price text-blue-400 font-black text-xs">Rp${formatIDR(b.harga)}</p>
                </div>
            `).join('');
            list.classList.toggle('hidden', res.length === 0);
        }

        function addToCart(id) {
            const b = dataBarang.find(x => x.id === id);
            if(b.stok <= 0) return toast("Stok Habis!", "red");
            const ex = keranjang.find(k => k.id === id && k.unit === 'PCS');
            if(ex) { ex.qty++; ex.sub = ex.qty * ex.harga; }
            else { keranjang.push({...b, qty:1, unit:'PCS', sub:b.harga}); }
            renderCart(); document.getElementById('dropdownSearch').classList.add('hidden');
            document.getElementById('inCari').value = "";
        }

        function renderCart() {
            let subtotalSemua = 0;
            document.getElementById('tabelKasir').innerHTML = keranjang.map((i, idx) => {
                subtotalSemua += i.sub;
                return `<tr>
                    <td class="p-4"><p class="font-black text-white uppercase">${i.nama}</p><p class="text-[8px] text-blue-400">@Rp${formatIDR(i.unit==='BOX'?i.hargaBox:i.harga)}</p></td>
                    <td class="p-4"><div class="flex items-center gap-1"><input type="number" value="${i.qty}" onchange="updQty(${idx}, this.value)" class="w-8 bg-slate-900 rounded p-1 text-center font-bold text-yellow-400 text-[10px]"><button onclick="toggleUnit(${idx})" class="text-[7px] font-black px-1.5 py-1 rounded ${i.unit==='BOX'?'bg-orange-600':'bg-blue-600'} text-white">${i.unit}</button></div></td>
                    <td class="p-4 text-right font-mono-price text-white font-bold">Rp${formatIDR(i.sub)}</td>
                    <td class="p-4 text-center"><button onclick="keranjang.splice(${idx},1);renderCart()" class="text-red-500">‚úï</button></td>
                </tr>`;
            }).join('');
            const diskon = toNum(document.getElementById('diskonManual').value);
            document.getElementById('totalBelanja').innerText = "Rp " + formatIDR(Math.max(0, subtotalSemua - diskon));
            hitungKembali();
        }

        function updQty(idx, v) { 
            keranjang[idx].qty = Math.max(1, parseInt(v)||1); 
            keranjang[idx].sub = (keranjang[idx].unit==='BOX'?keranjang[idx].hargaBox:keranjang[idx].harga) * keranjang[idx].qty;
            renderCart(); 
        }

        function toggleUnit(idx) {
            keranjang[idx].unit = keranjang[idx].unit==='PCS'?'BOX':'PCS';
            keranjang[idx].sub = (keranjang[idx].unit==='BOX'?keranjang[idx].hargaBox:keranjang[idx].harga) * keranjang[idx].qty;
            renderCart();
        }

        function hitungKembali() {
            const t = toNum(document.getElementById('totalBelanja').innerText);
            const b = toNum(document.getElementById('bayarTunai').value);
            document.getElementById('kembalianText').innerText = "Rp " + formatIDR(Math.max(0, b - t));
        }

        async function prosesBayar() {
            const t = toNum(document.getElementById('totalBelanja').innerText);
            const b = toNum(document.getElementById('bayarTunai').value);
            const diskon = toNum(document.getElementById('diskonManual').value);
            if(keranjang.length === 0 || b < t) return toast("Cek Tunai!", "red");
            try {
                const docRef = await db.collection("transaksi").add({
                    kasir: userAktif, total: t, bayar: b, kembali: b-t, diskon: diskon,
                    waktu: firebase.firestore.FieldValue.serverTimestamp(),
                    items: keranjang.map(i => ({nama:i.nama, qty:i.qty, sub:i.sub, unit:i.unit, hrg:i.unit==='BOX'?i.hargaBox:i.harga}))
                });
                lastTransactionId = docRef.id;
                for(let i of keranjang) {
                    const dec = i.unit === 'BOX' ? i.qty * 12 : i.qty;
                    const ref = db.collection("barang").doc(i.id);
                    await db.runTransaction(async (transaction) => {
                        const d = await transaction.get(ref);
                        transaction.update(ref, {stok: d.data().stok - dec});
                    });
                }
                document.getElementById('modal-print-confirm').classList.replace('hidden', 'flex');
            } catch(e) { toast("ERROR", "red"); }
        }

        function handlePrintDecision(shouldPrint) {
            document.getElementById('modal-print-confirm').classList.replace('flex', 'hidden');
            if(shouldPrint && lastTransactionId) printStruk(lastTransactionId);
            toast("BERHASIL!", "blue");
            resetKasir();
        }

        function resetKasir() {
            keranjang=[]; document.getElementById('bayarTunai').value=""; 
            document.getElementById('diskonManual').value=""; renderCart();
        }

        function printStruk(id) {
            const t = dataTransaksi.find(x => x.id === id);
            if(!t) return;
            const printArea = document.getElementById('print-area');
            const d = t.waktu?.toDate() || new Date();
            const dateStr = d.toLocaleDateString('id-ID') + ' ' + d.toLocaleTimeString('id-ID');
            printArea.innerHTML = `
                <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:5px; margin-bottom:5px;">
                    <b style="font-size:14px">AMALIA STORE</b><br>POS System
                </div>
                <div style="margin-bottom:5px">Kasir: ${t.kasir}<br>${dateStr}</div>
                <table style="width:100%; border-bottom:1px dashed #000; margin-bottom:5px;">
                    ${t.items.map(i => `<tr><td>${i.nama}<br>${i.qty} ${i.unit} x ${formatIDR(i.hrg)}</td><td style="text-align:right; vertical-align:bottom">${formatIDR(i.sub)}</td></tr>`).join('')}
                </table>
                <table style="width:100%">
                    ${t.diskon ? `<tr><td>Diskon</td><td style="text-align:right">-${formatIDR(t.diskon)}</td></tr>` : ''}
                    <tr><td><b>TOTAL</b></td><td style="text-align:right"><b>${formatIDR(t.total)}</b></td></tr>
                    <tr><td>Tunai</td><td style="text-align:right">${formatIDR(t.bayar)}</td></tr>
                    <tr><td>Kembali</td><td style="text-align:right">${formatIDR(t.kembali)}</td></tr>
                </table>
                <div style="text-align:center; margin-top:10px; border-top:1px dashed #000; padding-top:5px;">Terima Kasih</div>
            `;
            window.print();
        }

        // --- ADMIN ---
        function renderAdminTable(f = '') {
            const res = dataBarang.filter(b => b.nama.toLowerCase().includes(f.toLowerCase()));
            document.getElementById('tabelAdmin').innerHTML = res.map(b => `
                <tr class="hover:bg-white/[0.02]">
                    <td class="p-4 font-black text-white uppercase">${b.nama}</td>
                    <td class="p-4 font-mono-price text-blue-400">Rp${formatIDR(b.harga)}</td>
                    <td class="p-4 font-mono-price text-orange-400">Rp${formatIDR(b.hargaBox)}</td>
                    <td class="p-4"><span class="badge-stok ${b.stok < 10 ? 'badge-stok-low' : ''}">${b.stok}</span></td>
                    <td class="p-4 text-right whitespace-nowrap"><button onclick="openEdit('${b.id}')" class="text-blue-500 mr-3">‚úé</button><button onclick="deleteBarang('${b.id}')" class="text-red-500">üóë</button></td>
                </tr>
            `).join('');
        }

        async function simpanBarang() {
            const d = { 
                nama: document.getElementById('admNama').value.toUpperCase(),
                harga: toNum(document.getElementById('admEcer').value),
                hargaBox: toNum(document.getElementById('admGrosir').value),
                stok: parseInt(document.getElementById('admStok').value) || 0
            };
            if(!d.nama || !d.harga) return toast("Lengkapi!", "red");
            await db.collection("barang").add(d);
            document.querySelectorAll('#admForm input').forEach(i => i.value="");
            toast("TERSIPMAN!", "blue");
        }

        function openEdit(id) {
            editingId = id; const b = dataBarang.find(x => x.id === id);
            document.getElementById('editNama').value = b.nama;
            document.getElementById('editEcer').value = formatIDR(b.harga);
            document.getElementById('editGrosir').value = formatIDR(b.hargaBox);
            document.getElementById('editStok').value = b.stok;
            document.getElementById('modal-edit').classList.replace('hidden', 'flex');
        }

        async function updateBarang() {
            await db.collection("barang").doc(editingId).update({
                nama: document.getElementById('editNama').value.toUpperCase(),
                harga: toNum(document.getElementById('editEcer').value),
                hargaBox: toNum(document.getElementById('editGrosir').value),
                stok: parseInt(document.getElementById('editStok').value) || 0
            });
            closeEditModal(); toast("DIUPDATE!", "blue");
        }

        function closeEditModal() { document.getElementById('modal-edit').classList.replace('flex', 'hidden'); }
        async function deleteBarang(id) { if(confirm('Hapus?')) await db.collection("barang").doc(id).delete(); }

        // --- HISTORY ---
        function renderHistory() {
            document.getElementById('history-list').innerHTML = dataTransaksi.map(t => {
                const d = t.waktu?.toDate();
                const fD = d ? d.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' }) : '-';
                const fT = d ? d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                return `
                <div class="glass-card p-5 rounded-3xl border-white/5 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-blue-600"></div>
                    <div class="flex justify-between items-start mb-3 border-b border-white/5 pb-3">
                        <div>
                            <p class="text-[8px] text-blue-400 font-bold uppercase">Petugas</p>
                            <h3 class="text-sm font-black text-yellow-400 uppercase leading-none">${t.kasir}</h3>
                        </div>
                        <button onclick="printStruk('${t.id}')" class="bg-white/5 p-2 rounded-lg text-[8px] font-black uppercase">Cetak üñ®Ô∏è</button>
                        <div class="text-right">
                            <p class="text-[8px] text-slate-400 font-bold uppercase">${fD}</p>
                            <p class="text-xs font-black text-white italic">${fT}</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-end">
                        <div class="text-[9px] text-white/60 space-y-1">
                            ${t.items.slice(0,2).map(i => `<div>${i.nama} x${i.qty}</div>`).join('')}
                            ${t.items.length > 2 ? '<div>...</div>' : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-[8px] text-blue-400 font-black uppercase">Total</p>
                            <h2 class="text-lg font-black font-mono-price text-white">Rp${formatIDR(t.total)}</h2>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function updateLaporan() {
            const total = dataTransaksi.reduce((a, b) => a + (b.total || 0), 0);
            document.getElementById('omzet-all').innerText = "Rp " + formatIDR(total);
            document.getElementById('all-count-total').innerText = dataTransaksi.length;
            filterLaporan();
        }

        function filterLaporan() {
            const d = document.getElementById('pick-day').value;
            const m = document.getElementById('pick-month').value;
            let f = dataTransaksi;
            if(d) f = dataTransaksi.filter(t => t.waktu?.toDate().toISOString().split('T')[0] === d);
            else if(m) f = dataTransaksi.filter(t => t.waktu?.toDate().toISOString().slice(0,7) === m);
            const total = f.reduce((a,b) => a + (b.total||0), 0);
            document.getElementById('lap-omzet').innerText = "Rp " + formatIDR(total);
            document.getElementById('lap-count').innerText = f.length;
        }

        window.addEventListener('keydown', (e) => { if(e.key === 'F8') document.getElementById('bayarTunai').focus(); });
    </script>
</body>
</html>
