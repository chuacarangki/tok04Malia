<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMALIA POS PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #3b82f6; --bg: #020617; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            color: #f8fafc; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .font-mono-price { font-family: 'JetBrains Mono', monospace; }
        
        /* Scrollbar custom agar tetap minimalis */
        .custom-scroll { overflow-y: auto !important; }
        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.5); border-radius: 10px; }

        .badge-stok { 
            background: #facc15; color: #000; padding: 2px 6px; border-radius: 4px; 
            font-weight: 800; font-size: 10px;
        }

        /* Navigation Style */
        .nav-btn { 
            transition: 0.3s; color: #64748b; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; flex: 1;
        }
        .nav-btn.active { color: #3b82f6; }

        /* Toast Animation */
        #toast { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) scale(0.5); 
            z-index: 9999; opacity: 0; visibility: hidden; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            width: 90%; max-width: 320px;
        }
        #toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) scale(1); }

        input { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); color: white; outline: none; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        /* Responsive Layout */
        @media (max-width: 768px) {
            .section-page { height: calc(100vh - 135px); }
            .hide-on-mobile { display: none; }
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 58mm; color: black !important; }
        }
    </style>
</head>
<body>

    <div id="print-area" class="hidden text-black font-mono w-[58mm] text-[10px]"></div>

    <div id="toast">
        <div id="toast-inner" class="glass-card px-6 py-3 rounded-2xl border-l-4 border-blue-500 shadow-2xl flex items-center gap-3">
            <span id="toast-icon"></span>
            <span id="toast-text" class="text-xs font-bold uppercase tracking-wider text-white"></span>
        </div>
    </div>

    <div id="login-page" class="fixed inset-0 z-[1000] bg-[#020617] flex items-center justify-center p-6">
        <div class="glass-card p-10 rounded-[45px] w-full max-w-sm text-center border-white/10 shadow-2xl">
            <div class="w-20 h-20 bg-blue-600 rounded-[25px] flex items-center justify-center font-black italic text-white text-4xl mx-auto mb-6 shadow-[0_0_30px_rgba(59,130,246,0.5)]">A</div>
            <h1 class="text-3xl font-black italic text-white mb-1">AMALIA<span class="text-blue-500">.</span></h1>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.4em] mb-10">Point of Sale Pro</p>
            <input type="text" id="inNamaUser" placeholder="NAMA PETUGAS" class="w-full p-4 rounded-2xl text-center font-black uppercase mb-4 text-sm tracking-widest">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="attemptLogin('Kasir')" class="bg-white/5 hover:bg-white/10 p-4 rounded-2xl font-bold text-[10px] uppercase transition-all">KASIR</button>
                <button onclick="attemptLogin('Admin')" class="bg-blue-600 hover:bg-blue-700 p-4 rounded-2xl font-bold text-[10px] uppercase shadow-lg transition-all">ADMIN</button>
            </div>
        </div>
    </div>

    <header class="p-4 px-6 flex justify-between items-center glass-card border-b border-white/5 shrink-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-black italic text-white text-sm">A</div>
            <h1 class="text-lg font-black italic text-white tracking-tighter">AMALIA<span class="text-blue-500">.</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right leading-none hide-on-mobile">
                <p id="user-info" class="text-[10px] font-black uppercase text-white"></p>
                <p id="role-info" class="text-[8px] font-bold text-blue-500 uppercase"></p>
            </div>
            <button onclick="location.reload()" class="bg-red-500/10 hover:bg-red-500/20 text-red-500 px-3 py-1 rounded-lg font-bold text-[10px] uppercase transition-all">Logout</button>
        </div>
    </header>

    <main class="flex-grow flex flex-col overflow-hidden">
        
        <div id="sec-kasir" class="section-page w-full flex flex-col md:flex-row overflow-hidden">
            <div class="flex-grow p-4 flex flex-col overflow-hidden">
                <div class="relative mb-4">
                    <input type="text" id="inCari" oninput="searchBarang(this.value)" placeholder="Cari Nama Produk..." class="w-full p-4 pl-12 rounded-2xl text-sm font-bold shadow-xl">
                    <span class="absolute left-5 top-4 opacity-30">üîç</span>
                    <div id="dropdownSearch" class="absolute top-full left-0 right-0 glass-card rounded-2xl mt-2 z-[100] max-h-[50vh] overflow-y-auto custom-scroll hidden shadow-[0_20px_50px_rgba(0,0,0,0.5)] border-white/10"></div>
                </div>
                
                <div class="glass-card rounded-[30px] flex-grow overflow-hidden flex flex-col border-white/5 shadow-inner">
                    <div class="overflow-y-auto custom-scroll flex-grow">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-900/80 sticky top-0 font-bold uppercase text-slate-500 text-[9px] tracking-widest">
                                <tr><th class="p-4">Item</th><th class="p-4 text-center">Qty</th><th class="p-4 text-right">Subtotal</th><th class="p-4"></th></tr>
                            </thead>
                            <tbody id="tabelKasir" class="divide-y divide-white/5"></tbody>
                        </table>
                        <div id="cart-empty" class="p-20 text-center opacity-20 flex flex-col items-center">
                            <span class="text-5xl mb-2">üõí</span>
                            <p class="text-[10px] font-bold uppercase tracking-widest">Keranjang Kosong</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-96 p-4 md:p-6 glass-card border-t md:border-l border-white/5 flex flex-col gap-4 shrink-0 bg-[#020617]/80">
                <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-6 rounded-[30px] shadow-[0_10px_30px_rgba(59,130,246,0.3)] relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-[9px] font-black uppercase mb-1 opacity-70 tracking-[0.2em]">Total Tagihan</p>
                        <h1 id="totalBelanja" class="text-3xl font-black font-mono-price tracking-tighter text-white">Rp 0</h1>
                    </div>
                    <div class="absolute -right-4 -bottom-4 text-white/10 text-7xl font-black italic">POS</div>
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    <div class="p-4 bg-white/5 rounded-2xl border border-white/10 flex justify-between items-center">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Diskon</span>
                        <input type="text" id="diskonManual" oninput="formatMoneyInput(this); renderCart()" class="bg-transparent text-right font-black text-orange-400 w-1/2" placeholder="0">
                    </div>
                    <div class="p-4 bg-white/5 rounded-2xl border border-white/10 flex justify-between items-center">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Tunai</span>
                        <input type="text" id="bayarTunai" oninput="formatMoneyInput(this); hitungKembali()" class="bg-transparent text-right font-black text-blue-400 w-1/2 text-lg" placeholder="Rp 0">
                    </div>
                    <div class="p-4 bg-slate-900/50 rounded-2xl border border-white/5 flex justify-between items-center">
                        <span class="text-[9px] text-slate-500 font-black uppercase tracking-widest">Kembali</span>
                        <span id="kembalianText" class="text-xl font-black text-green-400 font-mono-price">Rp 0</span>
                    </div>
                </div>
                <button onclick="prosesBayar()" class="w-full bg-blue-600 hover:bg-blue-700 py-5 rounded-[20px] font-black text-xs uppercase tracking-[0.2em] shadow-xl transition-all active:scale-95">Selesaikan Transaksi</button>
            </div>
        </div>

        <div id="sec-history" class="section-page hidden w-full overflow-y-auto custom-scroll p-4 pb-24">
            <div class="max-w-xl mx-auto space-y-3" id="history-list"></div>
        </div>

        <div id="sec-laporan" class="section-page hidden w-full overflow-y-auto custom-scroll p-4 pb-24">
            <div class="max-w-xl mx-auto space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-card p-6 rounded-3xl border-t-4 border-blue-600">
                        <p class="text-[10px] text-slate-500 font-black uppercase mb-2">Total Omzet</p>
                        <h1 id="omzet-all" class="text-xl font-black font-mono-price text-white">Rp 0</h1>
                    </div>
                    <div class="glass-card p-6 rounded-3xl border-t-4 border-green-600">
                        <p class="text-[10px] text-slate-500 font-black uppercase mb-2">Transaksi</p>
                        <h1 id="all-count-total" class="text-3xl font-black text-white">0</h1>
                    </div>
                </div>
                <div class="glass-card p-6 rounded-3xl">
                    <p class="text-[10px] text-slate-500 font-black uppercase mb-4">Filter Tanggal</p>
                    <input type="date" id="pick-day" onchange="filterLaporan()" class="w-full p-4 rounded-xl text-xs font-bold uppercase mb-4">
                    <div class="flex justify-between items-end border-t border-white/5 pt-4">
                        <div><p class="text-[10px] text-blue-400 font-black uppercase">Hasil Filter</p><h2 id="lap-omzet" class="text-2xl font-black font-mono-price text-white">Rp 0</h2></div>
                        <div class="text-right"><p class="text-[10px] text-slate-500 font-black uppercase">Qty</p><h2 id="lap-count" class="text-2xl font-black text-white">0</h2></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-admin" class="section-page hidden w-full p-4 flex flex-col gap-4 overflow-hidden pb-24">
            <div class="max-w-2xl mx-auto w-full flex flex-col h-full">
                <button onclick="document.getElementById('modal-add-barang').classList.replace('hidden','flex')" class="w-full bg-blue-600 hover:bg-blue-700 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg mb-4">+ Tambah Produk</button>
                <div class="flex-grow glass-card rounded-[30px] flex flex-col overflow-hidden border-white/5">
                    <div class="p-4 bg-white/5">
                        <input type="text" oninput="renderAdminTable(this.value)" placeholder="Cari di database..." class="w-full p-3 px-5 rounded-xl text-xs font-bold uppercase">
                    </div>
                    <div id="tabelAdminMobile" class="flex-grow overflow-y-auto custom-scroll p-4 space-y-3"></div>
                </div>
            </div>
        </div>
    </main>

    <nav id="main-nav" class="fixed bottom-0 left-0 right-0 h-[75px] bg-[#0f172a]/95 backdrop-blur-xl border-t border-white/10 flex items-center justify-around px-4 z-[100] hidden shadow-[0_-10px_30px_rgba(0,0,0,0.5)]">
        <button id="nav-kasir" onclick="showSection('kasir')" class="nav-btn active">
            <span class="text-xl mb-1">üõí</span><span class="tracking-tighter">KASIR</span>
        </button>
        <button id="nav-history" onclick="showSection('history')" class="nav-btn">
            <span class="text-xl mb-1">üìú</span><span class="tracking-tighter">RIWAYAT</span>
        </button>
        <button id="nav-laporan" onclick="showSection('laporan')" class="nav-btn">
            <span class="text-xl mb-1">üìà</span><span class="tracking-tighter">LAPORAN</span>
        </button>
        <button id="nav-admin" onclick="showSection('admin')" class="nav-btn hidden !text-blue-400">
            <span class="text-xl mb-1">‚öôÔ∏è</span><span class="tracking-tighter">ADMIN</span>
        </button>
    </nav>

    <div id="modal-edit" class="fixed inset-0 z-[1005] bg-black/90 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-sm border-white/20">
            <h2 class="text-xl font-black mb-6 text-blue-400 uppercase italic">Edit Data Produk</h2>
            <div class="space-y-4">
                <input type="text" id="editNama" class="w-full p-4 rounded-2xl font-bold uppercase text-sm">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="editEcer" oninput="formatMoneyInput(this)" class="p-4 rounded-2xl font-mono-price text-sm" placeholder="Harga Ecer">
                    <input type="text" id="editGrosir" oninput="formatMoneyInput(this)" class="p-4 rounded-2xl font-mono-price text-sm" placeholder="Harga Box">
                </div>
                <input type="number" id="editStok" class="w-full p-4 rounded-2xl font-bold text-sm" placeholder="Stok">
                <div class="flex gap-3 pt-4">
                    <button onclick="closeEditModal()" class="flex-1 py-4 text-slate-500 text-[10px] font-black uppercase">Batal</button>
                    <button onclick="updateBarang()" class="flex-[2] bg-blue-600 py-4 rounded-2xl font-black text-xs uppercase shadow-blue-500/20 shadow-lg">Update Data</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-add-barang" class="fixed inset-0 z-[1005] bg-black/90 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-sm border-white/20">
            <h2 class="text-xl font-black mb-6 text-blue-400 uppercase italic">Produk Baru</h2>
            <div class="space-y-4" id="admForm">
                <input type="text" id="admNama" placeholder="NAMA BARANG" class="w-full p-4 rounded-2xl text-xs font-black uppercase">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="admEcer" oninput="formatMoneyInput(this)" placeholder="HARGA ECER" class="w-full p-4 rounded-2xl font-mono-price text-sm">
                    <input type="text" id="admGrosir" oninput="formatMoneyInput(this)" placeholder="HARGA BOX" class="w-full p-4 rounded-2xl font-mono-price text-sm">
                </div>
                <input type="number" id="admStok" placeholder="STOK AWAL" class="w-full p-4 rounded-2xl font-bold text-sm">
                <div class="flex gap-3 pt-4">
                    <button onclick="document.getElementById('modal-add-barang').classList.replace('flex','hidden')" class="flex-1 py-4 text-slate-500 text-[10px] font-black uppercase">Batal</button>
                    <button onclick="simpanBarangMobile()" class="flex-[2] bg-blue-600 py-4 rounded-2xl font-black text-xs uppercase shadow-lg">Simpan Produk</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-pass" class="fixed inset-0 z-[1001] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-2xl">
        <div class="glass-card p-10 rounded-[45px] w-full max-w-xs text-center border-white/10 shadow-2xl">
            <div class="text-4xl mb-4">üîê</div>
            <h2 class="text-[10px] font-black mb-6 text-white uppercase tracking-[0.3em]">Otoritas Admin</h2>
            <input type="password" id="admin-pass-input" pattern="\d*" inputmode="numeric" class="w-full p-5 rounded-[25px] mb-6 text-center text-3xl font-black tracking-[0.5em] bg-white/5 border-white/10">
            <button onclick="checkAdminPass()" class="w-full bg-blue-600 py-5 rounded-[20px] font-black uppercase text-[10px] tracking-widest shadow-lg active:scale-95 transition-all">Verifikasi</button>
            <button onclick="closePassModal()" class="mt-6 text-[9px] text-slate-500 font-bold uppercase tracking-widest">Kembali</button>
        </div>
    </div>

    <div id="modal-print-confirm" class="fixed inset-0 z-[1010] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-card p-10 rounded-[50px] w-full max-w-sm text-center border-white/10 shadow-2xl">
            <div class="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-4xl">‚úÖ</span></div>
            <h2 class="text-2xl font-black text-white uppercase mb-2">Sukses!</h2>
            <p class="text-slate-500 font-bold text-[10px] mb-8 uppercase tracking-[0.2em]">Cetak Struk Sekarang?</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="handlePrintDecision(true)" class="bg-blue-600 py-5 rounded-[25px] font-black uppercase text-[10px] tracking-widest shadow-lg">YA</button>
                <button onclick="handlePrintDecision(false)" class="bg-white/5 py-5 rounded-[25px] font-black uppercase text-[10px] tracking-widest border border-white/10">TIDAK</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG FIREBASE (Sesuai akun Anda)
        const config = {
            apiKey: "AIzaSyBhrN6vuBzuxwFgPI-iXJky6ErDz8auclY",
            authDomain: "toko4malia.firebaseapp.com",
            projectId: "toko4malia",
            storageBucket: "toko4malia.firebasestorage.app",
            messagingSenderId: "1053922856540",
            appId: "1:1053922856540:web:34f5e6de7d5538b1e66099"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();

        let dataBarang = [], dataTransaksi = [], keranjang = [], userAktif = '', userRole = '', editingId = null;
        let lastTransactionId = null;

        const formatIDR = (n) => new Intl.NumberFormat('id-ID').format(n || 0);
        const toNum = (s) => parseInt(s?.toString().replace(/[^0-9]/g, '')) || 0;

        function formatMoneyInput(el) {
            let v = toNum(el.value);
            el.value = v === 0 ? "" : formatIDR(v);
        }

        function toast(msg, type = 'blue') {
            const t = document.getElementById('toast');
            const txt = document.getElementById('toast-text');
            const ico = document.getElementById('toast-icon');
            const inner = document.getElementById('toast-inner');
            inner.style.borderLeftColor = type === 'red' ? '#ef4444' : '#3b82f6';
            ico.innerHTML = type === 'red' ? '‚ö†Ô∏è' : '‚úÖ';
            txt.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function attemptLogin(role) {
            const name = document.getElementById('inNamaUser').value;
            if(!name) return toast("Input Nama!", "red");
            if(role === 'Admin') document.getElementById('modal-pass').classList.replace('hidden', 'flex');
            else loginSuccess(name, 'Kasir');
        }

        function checkAdminPass() {
            if(document.getElementById('admin-pass-input').value === '1212') {
                loginSuccess(document.getElementById('inNamaUser').value, 'Admin');
                closePassModal();
            } else { toast("PIN SALAH!", "red"); }
        }

        function loginSuccess(name, role) {
            userAktif = name; userRole = role;
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('user-info').innerText = name;
            document.getElementById('role-info').innerText = role;
            if(role === 'Admin') document.getElementById('nav-admin').classList.remove('hidden');
            showSection('kasir'); syncData();
        }

        function closePassModal() { document.getElementById('modal-pass').classList.replace('flex', 'hidden'); }

        function syncData() {
            db.collection("barang").onSnapshot(snap => {
                dataBarang = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAdminTable();
            });
            db.collection("transaksi").orderBy("waktu", "desc").onSnapshot(snap => {
                dataTransaksi = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderHistory(); updateLaporan();
            });
        }

        function showSection(id) {
            document.querySelectorAll('.section-page').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + id).classList.add('active');
        }

        // --- KASIR ---
        function searchBarang(val) {
            const list = document.getElementById('dropdownSearch');
            if(!val) return list.classList.add('hidden');
            const res = dataBarang.filter(b => b.nama.toLowerCase().includes(val.toLowerCase()));
            list.innerHTML = res.map(b => `
                <div onclick="addToCart('${b.id}')" class="p-5 border-b border-white/5 flex justify-between items-center active:bg-blue-600/20">
                    <div>
                        <p class="font-black text-white uppercase text-xs mb-1 tracking-wider">${b.nama}</p>
                        <span class="badge-stok ${b.stok < 5 ? 'bg-red-500 text-white' : ''}">STOK: ${b.stok}</span>
                    </div>
                    <p class="font-mono-price text-blue-400 font-black text-sm">Rp${formatIDR(b.harga)}</p>
                </div>
            `).join('');
            list.classList.toggle('hidden', res.length === 0);
        }

        function addToCart(id) {
            const b = dataBarang.find(x => x.id === id);
            if(b.stok <= 0) return toast("Stok Habis!", "red");
            const ex = keranjang.find(k => k.id === id && k.unit === 'PCS');
            if(ex) { ex.qty++; ex.sub = ex.qty * ex.harga; }
            else { keranjang.push({...b, qty:1, unit:'PCS', sub:b.harga}); }
            renderCart(); 
            document.getElementById('dropdownSearch').classList.add('hidden');
            document.getElementById('inCari').value = "";
        }

        function renderCart() {
            let subtotalSemua = 0;
            const container = document.getElementById('tabelKasir');
            document.getElementById('cart-empty').classList.toggle('hidden', keranjang.length > 0);
            
            container.innerHTML = keranjang.map((i, idx) => {
                subtotalSemua += i.sub;
                return `<tr>
                    <td class="p-4">
                        <p class="font-black text-white uppercase text-[11px] mb-1">${i.nama}</p>
                        <p class="text-[9px] font-bold text-blue-400">@ ${formatIDR(i.unit==='BOX'?i.hargaBox:i.harga)}</p>
                    </td>
                    <td class="p-4">
                        <div class="flex flex-col items-center gap-2">
                            <input type="number" value="${i.qty}" onchange="updQty(${idx}, this.value)" class="w-12 bg-slate-900/80 border-none rounded-lg p-1.5 text-center font-black text-yellow-400 text-xs shadow-inner">
                            <button onclick="toggleUnit(${idx})" class="text-[8px] font-black px-3 py-1 rounded-full ${i.unit==='BOX'?'bg-orange-600':'bg-blue-600'} text-white shadow-lg transition-all active:scale-90">${i.unit}</button>
                        </div>
                    </td>
                    <td class="p-4 text-right font-mono-price text-white font-black text-[11px]">Rp${formatIDR(i.sub)}</td>
                    <td class="p-4 text-center"><button onclick="keranjang.splice(${idx},1);renderCart()" class="text-red-500 opacity-50 hover:opacity-100">‚úï</button></td>
                </tr>`;
            }).join('');
            const diskon = toNum(document.getElementById('diskonManual').value);
            document.getElementById('totalBelanja').innerText = "Rp " + formatIDR(Math.max(0, subtotalSemua - diskon));
            hitungKembali();
        }

        function updQty(idx, v) { 
            keranjang[idx].qty = Math.max(1, parseInt(v)||1); 
            keranjang[idx].sub = (keranjang[idx].unit==='BOX'?keranjang[idx].hargaBox:keranjang[idx].harga) * keranjang[idx].qty;
            renderCart(); 
        }

        function toggleUnit(idx) {
            keranjang[idx].unit = keranjang[idx].unit==='PCS'?'BOX':'PCS';
            keranjang[idx].sub = (keranjang[idx].unit==='BOX'?keranjang[idx].hargaBox:keranjang[idx].harga) * keranjang[idx].qty;
            renderCart();
        }

        function hitungKembali() {
            const t = toNum(document.getElementById('totalBelanja').innerText);
            const b = toNum(document.getElementById('bayarTunai').value);
            const selisih = Math.max(0, b - t);
            document.getElementById('kembalianText').innerText = "Rp " + formatIDR(selisih);
        }

        async function prosesBayar() {
            const t = toNum(document.getElementById('totalBelanja').innerText);
            const b = toNum(document.getElementById('bayarTunai').value);
            if(keranjang.length === 0) return toast("Pilih Barang Dulu!", "red");
            if(b < t) return toast("Uang Tunai Kurang!", "red");

            try {
                const docRef = await db.collection("transaksi").add({
                    kasir: userAktif, total: t, bayar: b, kembali: b-t,
                    diskon: toNum(document.getElementById('diskonManual').value),
                    waktu: firebase.firestore.FieldValue.serverTimestamp(),
                    items: keranjang.map(i => ({nama:i.nama, qty:i.qty, sub:i.sub, unit:i.unit, hrg:i.unit==='BOX'?i.hargaBox:i.harga}))
                });
                lastTransactionId = docRef.id;
                for(let i of keranjang) {
                    const dec = i.unit === 'BOX' ? i.qty * 12 : i.qty; // Asumsi 1 box = 12 pcs
                    const ref = db.collection("barang").doc(i.id);
                    await db.runTransaction(async (transaction) => {
                        const d = await transaction.get(ref);
                        transaction.update(ref, {stok: d.data().stok - dec});
                    });
                }
                document.getElementById('modal-print-confirm').classList.replace('hidden', 'flex');
            } catch(e) { toast("ERROR: " + e.message, "red"); }
        }

        function handlePrintDecision(shouldPrint) {
            document.getElementById('modal-print-confirm').classList.replace('flex', 'hidden');
            if(shouldPrint && lastTransactionId) printStruk(lastTransactionId);
            toast("TRANSAKSI SELESAI");
            resetKasir();
        }

        function resetKasir() {
            keranjang=[]; 
            document.getElementById('bayarTunai').value=""; 
            document.getElementById('diskonManual').value=""; 
            renderCart();
        }

        function printStruk(id) {
            const t = dataTransaksi.find(x => x.id === id);
            if(!t) return;
            const printArea = document.getElementById('print-area');
            const d = t.waktu?.toDate() || new Date();
            
            printArea.innerHTML = `
                <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:5px; margin-bottom:5px;">
                    <b style="font-size:12px">AMALIA STORE</b><br>Mobile POS System
                </div>
                <div style="margin-bottom:5px;">
                    ${d.toLocaleDateString('id-ID')} ${d.toLocaleTimeString('id-ID')}<br>
                    Kasir: ${t.kasir}
                </div>
                <table style="width:100%; border-bottom:1px dashed #000; margin-bottom:5px;">
                    ${t.items.map(i => `
                        <tr><td colspan="2">${i.nama}</td></tr>
                        <tr><td>${i.qty} ${i.unit} x ${formatIDR(i.hrg)}</td><td style="text-align:right">${formatIDR(i.sub)}</td></tr>
                    `).join('')}
                </table>
                <table style="width:100%;">
                    ${t.diskon ? `<tr><td>Diskon</td><td style="text-align:right">-${formatIDR(t.diskon)}</td></tr>` : ''}
                    <tr><td><b>TOTAL</b></td><td style="text-align:right"><b>${formatIDR(t.total)}</b></td></tr>
                    <tr><td>Tunai</td><td style="text-align:right">${formatIDR(t.bayar)}</td></tr>
                    <tr><td>Kembali</td><td style="text-align:right">${formatIDR(t.kembali)}</td></tr>
                </table>
                <div style="text-align:center; margin-top:10px; border-top:1px dashed #000; padding-top:5px;">Terima Kasih</div>
            `;
            window.print();
        }

        // --- ADMIN ---
        function renderAdminTable(f = '') {
            const res = dataBarang.filter(b => b.nama.toLowerCase().includes(f.toLowerCase()));
            const container = document.getElementById('tabelAdminMobile');
            container.innerHTML = res.map(b => `
                <div class="glass-card p-5 rounded-[25px] flex justify-between items-center border-l-4 ${b.stok < 10 ? 'border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.2)]' : 'border-blue-500 shadow-lg'}">
                    <div>
                        <p class="font-black text-white text-xs uppercase mb-1 tracking-wider">${b.nama}</p>
                        <div class="flex gap-3 mb-2">
                            <span class="text-[10px] text-blue-400 font-bold font-mono-price">E: ${formatIDR(b.harga)}</span>
                            <span class="text-[10px] text-orange-400 font-bold font-mono-price">B: ${formatIDR(b.hargaBox)}</span>
                        </div>
                        <span class="badge-stok ${b.stok < 10 ? 'bg-red-500 text-white' : ''}">STOK: ${b.stok}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openEdit('${b.id}')" class="w-10 h-10 bg-blue-600/10 rounded-xl flex items-center justify-center text-blue-400 active:scale-90 transition-all">‚úé</button>
                        <button onclick="deleteBarang('${b.id}')" class="w-10 h-10 bg-red-500/10 rounded-xl flex items-center justify-center text-red-500 active:scale-90 transition-all">üóë</button>
                    </div>
                </div>
            `).join('');
        }

        async function simpanBarangMobile() {
            const d = { 
                nama: document.getElementById('admNama').value.toUpperCase(),
                harga: toNum(document.getElementById('admEcer').value),
                hargaBox: toNum(document.getElementById('admGrosir').value),
                stok: parseInt(document.getElementById('admStok').value) || 0
            };
            if(!d.nama || !d.harga) return toast("Lengkapi Form!", "red");
            await db.collection("barang").add(d);
            document.querySelectorAll('#admForm input').forEach(i => i.value="");
            document.getElementById('modal-add-barang').classList.replace('flex','hidden');
            toast("PRODUK DITAMBAHKAN");
        }

        function openEdit(id) {
            editingId = id; const b = dataBarang.find(x => x.id === id);
            document.getElementById('editNama').value = b.nama;
            document.getElementById('editEcer').value = formatIDR(b.harga);
            document.getElementById('editGrosir').value = formatIDR(b.hargaBox);
            document.getElementById('editStok').value = b.stok;
            document.getElementById('modal-edit').classList.replace('hidden', 'flex');
        }

        async function updateBarang() {
            await db.collection("barang").doc(editingId).update({
                nama: document.getElementById('editNama').value.toUpperCase(),
                harga: toNum(document.getElementById('editEcer').value),
                hargaBox: toNum(document.getElementById('editGrosir').value),
                stok: parseInt(document.getElementById('editStok').value) || 0
            });
            closeEditModal(); toast("DATA DIPERBARUI");
        }

        function closeEditModal() { document.getElementById('modal-edit').classList.replace('flex', 'hidden'); }
        async function deleteBarang(id) { if(confirm('Hapus produk ini?')) await db.collection("barang").doc(id).delete(); }

        function renderHistory() {
            document.getElementById('history-list').innerHTML = dataTransaksi.map(t => {
                const dateObj = t.waktu?.toDate() || new Date();
                return `
                <div class="glass-card p-5 rounded-[30px] border-l-4 border-blue-600 shadow-xl">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-[9px] text-blue-400 font-black uppercase tracking-widest">${t.kasir}</p>
                            <p class="text-[10px] text-slate-500 font-bold">${dateObj.toLocaleDateString('id-ID')} ‚Ä¢ ${dateObj.toLocaleTimeString('id-ID')}</p>
                        </div>
                        <button onclick="printStruk('${t.id}')" class="bg-blue-600/10 text-blue-400 p-2.5 rounded-xl text-[10px] font-black active:scale-90 transition-all">STRUK üñ®Ô∏è</button>
                    </div>
                    <div class="space-y-1.5 mb-4 border-y border-white/5 py-3">
                        ${t.items.slice(0,3).map(i => `
                            <div class="flex justify-between text-[10px] text-slate-300">
                                <span>${i.nama} x ${i.qty}</span>
                                <span class="font-mono-price text-white font-bold">Rp${formatIDR(i.sub)}</span>
                            </div>
                        `).join('')}
                        ${t.items.length > 3 ? `<p class="text-[9px] text-slate-600 italic">+ ${t.items.length - 3} item lainnya...</p>` : ''}
                    </div>
                    <div class="flex justify-between items-center bg-white/5 p-4 rounded-2xl">
                        <span class="text-[9px] text-slate-400 font-black uppercase tracking-widest">Total Akhir</span>
                        <span class="font-mono-price text-lg font-black text-white">Rp${formatIDR(t.total)}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function updateLaporan() {
            const total = dataTransaksi.reduce((a, b) => a + (b.total || 0), 0);
            document.getElementById('omzet-all').innerText = "Rp " + formatIDR(total);
            document.getElementById('all-count-total').innerText = dataTransaksi.length;
            filterLaporan();
        }

        function filterLaporan() {
            const d = document.getElementById('pick-day').value;
            let f = dataTransaksi;
            if(d) f = dataTransaksi.filter(t => t.waktu?.toDate().toISOString().split('T')[0] === d);
            const total = f.reduce((a,b) => a + (b.total||0), 0);
            document.getElementById('lap-omzet').innerText = "Rp " + formatIDR(total);
            document.getElementById('lap-count').innerText = f.length;
        }

        // F8 Shortcut (masih berfungsi di keyboard fisik)
        window.addEventListener('keydown', (e) => { if(e.key === 'F8') document.getElementById('bayarTunai').focus(); });
    </script>
</body>
</html>
