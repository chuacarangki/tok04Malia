<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMALIA POS PRO - Mobile Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #3b82f6; --bg: #020617; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            color: #f8fafc; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .font-mono-price { font-family: 'JetBrains Mono', monospace; }
        
        .custom-scroll { overflow-y: auto !important; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.3); border-radius: 10px; }

        .badge-stok { 
            background: #facc15; color: #000; padding: 2px 8px; border-radius: 6px; 
            font-weight: 800; font-size: 11px; display: inline-block;
        }
        .badge-stok-low { background: #ef4444; color: white; }

        .nav-btn { 
            transition: 0.3s; background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1); color: #94a3b8; 
            font-weight: 700; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; flex: 1; padding: 8px 0;
        }
        .nav-btn.active { 
            background: rgba(59, 130, 246, 0.2); color: white; border-color: var(--accent);
        }

        #toast { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) scale(0.5); 
            z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            width: 90%; max-width: 350px;
        }
        #toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) scale(1); }

        input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1); color: white; outline: none; -webkit-appearance: none; }
        input:focus { border-color: var(--accent); }

        /* Mobile Specific Adjustment */
        @media (max-width: 768px) {
            .section-page { height: calc(100vh - 140px); }
            .mobile-bottom-panel { position: fixed; bottom: 70px; left: 0; right: 0; z-index: 40; }
            .admin-grid { grid-template-columns: 1fr !important; }
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 58mm; color: black !important; font-size: 10px; }
        }
    </style>
</head>
<body>

    <div id="print-area" class="hidden text-black font-mono w-[58mm] leading-tight"></div>

    <div id="toast">
        <div id="toast-inner" class="glass-card px-6 py-4 rounded-2xl border-t-4 border-blue-500 shadow-2xl text-center">
            <span id="toast-icon" class="text-2xl mr-2"></span>
            <span id="toast-text" class="text-sm font-bold uppercase tracking-wider text-white"></span>
        </div>
    </div>

    <div id="login-page" class="fixed inset-0 z-[1000] bg-[#020617] flex items-center justify-center p-4">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-sm text-center border-white/10">
            <h1 class="text-4xl font-black italic text-blue-500 mb-1">AMALIA</h1>
            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.3em] mb-8">Point of Sale Mobile</p>
            <input type="text" id="inNamaUser" placeholder="NAMA PETUGAS" class="w-full p-4 rounded-2xl text-center font-black uppercase mb-4 text-sm">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="attemptLogin('Kasir')" class="bg-white/5 p-4 rounded-2xl font-bold text-[10px] uppercase">KASIR</button>
                <button onclick="attemptLogin('Admin')" class="bg-blue-600 p-4 rounded-2xl font-bold text-[10px] uppercase">ADMIN</button>
            </div>
        </div>
    </div>

    <header class="p-4 px-6 flex justify-between items-center glass-card border-b border-white/5 shrink-0 z-50">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-black italic text-white text-sm">A</div>
            <h1 class="text-lg font-black italic text-white">AMALIA<span class="text-blue-500">.</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right leading-none">
                <p id="user-info" class="text-[10px] font-black uppercase text-white"></p>
                <p id="role-info" class="text-[8px] font-bold text-blue-500 uppercase"></p>
            </div>
            <button onclick="location.reload()" class="bg-red-500/10 text-red-500 w-8 h-8 rounded-lg flex items-center justify-center font-bold">‚úï</button>
        </div>
    </header>

    <main class="flex-grow flex flex-col overflow-hidden relative">
        
        <div id="sec-kasir" class="section-page w-full flex flex-col md:flex-row overflow-hidden">
            <div class="flex-grow p-4 flex flex-col overflow-hidden">
                <div class="relative mb-3">
                    <input type="text" id="inCari" oninput="searchBarang(this.value)" placeholder="Cari Nama Produk..." class="w-full p-4 rounded-xl text-sm font-bold">
                    <div id="dropdownSearch" class="absolute top-full left-0 right-0 glass-card rounded-2xl mt-1 z-[100] max-h-[60vh] overflow-y-auto custom-scroll hidden shadow-2xl"></div>
                </div>
                
                <div class="glass-card rounded-2xl flex-grow overflow-hidden flex flex-col">
                    <div class="overflow-y-auto custom-scroll flex-grow">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-900/50 sticky top-0 font-bold uppercase text-slate-500">
                                <tr><th class="p-3">Item</th><th class="p-3">Qty</th><th class="p-3 text-right">Sub</th><th class="p-3"></th></tr>
                            </thead>
                            <tbody id="tabelKasir" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-80 p-4 md:p-6 glass-card border-t md:border-l border-white/5 flex flex-col gap-3 shrink-0 bg-[#020617]/90 md:bg-transparent">
                <div class="flex justify-between items-center md:block bg-gradient-to-br from-blue-600 to-blue-800 p-4 rounded-2xl shadow-lg">
                    <div>
                        <p class="text-[8px] font-bold uppercase mb-0 opacity-80">Total Tagihan</p>
                        <h1 id="totalBelanja" class="text-xl md:text-3xl font-black font-mono-price">Rp 0</h1>
                    </div>
                    <button onclick="prosesBayar()" class="md:hidden bg-white/20 px-4 py-2 rounded-lg font-black text-xs uppercase">BAYAR</button>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-1 gap-2">
                    <div class="p-2 bg-white/5 rounded-xl border border-white/10">
                        <label class="text-[8px] font-bold text-slate-400 uppercase">Diskon</label>
                        <input type="text" id="diskonManual" oninput="formatMoneyInput(this); renderCart()" class="w-full bg-transparent text-sm font-bold text-orange-400" placeholder="0">
                    </div>
                    <div class="p-2 bg-white/5 rounded-xl border border-white/10">
                        <label class="text-[8px] font-bold text-slate-400 uppercase">Tunai</label>
                        <input type="text" id="bayarTunai" oninput="formatMoneyInput(this); hitungKembali()" class="w-full bg-transparent text-sm font-black text-blue-400" placeholder="Rp 0">
                    </div>
                </div>
                <div class="hidden md:flex flex-col p-3 bg-slate-900/50 rounded-xl border border-white/5">
                    <span class="text-[8px] text-slate-500 font-bold uppercase">Kembali</span>
                    <span id="kembalianText" class="text-xl font-black text-green-400 font-mono-price">Rp 0</span>
                </div>
                <button onclick="prosesBayar()" class="hidden md:block w-full bg-blue-600 py-4 rounded-xl font-black text-sm uppercase transition-all active:scale-95">Proses Transaksi</button>
            </div>
        </div>

        <div id="sec-history" class="section-page hidden w-full overflow-y-auto custom-scroll p-4 pb-24">
            <div class="max-w-xl mx-auto space-y-4" id="history-list"></div>
        </div>

        <div id="sec-laporan" class="section-page hidden w-full overflow-y-auto custom-scroll p-4 pb-24">
            <div class="max-w-xl mx-auto space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="glass-card p-4 rounded-2xl bg-gradient-to-br from-blue-900/40 to-transparent">
                        <p class="text-[8px] text-blue-400 font-black uppercase">Total Omzet</p>
                        <h1 id="omzet-all" class="text-lg font-black font-mono-price">Rp 0</h1>
                    </div>
                    <div class="glass-card p-4 rounded-2xl flex flex-col justify-center">
                        <p class="text-[8px] text-slate-500 font-black uppercase">Transaksi</p>
                        <h1 id="all-count-total" class="text-xl font-black">0</h1>
                    </div>
                </div>
                <div class="glass-card p-4 rounded-2xl flex flex-col gap-3">
                    <input type="date" id="pick-day" onchange="filterLaporan()" class="w-full p-3 rounded-xl text-xs font-bold uppercase">
                    <div class="flex justify-between items-center border-t border-white/5 pt-3">
                        <div><p class="text-[8px] text-yellow-400 font-bold uppercase">Filter</p><h2 id="lap-omzet" class="text-lg font-black font-mono-price">Rp 0</h2></div>
                        <div class="text-right"><p class="text-[8px] text-slate-400 uppercase">Qty</p><h2 id="lap-count" class="text-lg font-black">0</h2></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-admin" class="section-page hidden w-full p-4 flex flex-col gap-4 overflow-hidden pb-24">
            <button onclick="document.getElementById('modal-add-barang').classList.replace('hidden','flex')" class="w-full bg-blue-600 py-3 rounded-xl font-black text-xs uppercase shadow-lg"> + Tambah Produk Baru</button>
            
            <div class="flex-grow glass-card rounded-2xl flex flex-col overflow-hidden">
                <div class="p-3 bg-white/5 border-b border-white/10">
                    <input type="text" oninput="renderAdminTable(this.value)" placeholder="Cari di Database..." class="w-full p-3 rounded-xl text-xs font-bold uppercase">
                </div>
                <div class="flex-grow overflow-y-auto custom-scroll">
                    <div id="tabelAdminMobile" class="p-3 space-y-2"></div>
                </div>
            </div>
        </div>
    </main>

    <nav id="main-nav" class="fixed bottom-0 left-0 right-0 h-[70px] bg-[#0f172a] border-t border-white/10 flex items-center justify-around px-2 z-[100] hidden">
        <button id="nav-kasir" onclick="showSection('kasir')" class="nav-btn active">
            <span class="text-lg">üõí</span><span>KASIR</span>
        </button>
        <button id="nav-history" onclick="showSection('history')" class="nav-btn">
            <span class="text-lg">üìú</span><span>RIWAYAT</span>
        </button>
        <button id="nav-laporan" onclick="showSection('laporan')" class="nav-btn">
            <span class="text-lg">üìà</span><span>LAPORAN</span>
        </button>
        <button id="nav-admin" onclick="showSection('admin')" class="nav-btn hidden !text-blue-400">
            <span class="text-lg">‚öôÔ∏è</span><span>ADMIN</span>
        </button>
    </nav>

    <div id="modal-edit" class="fixed inset-0 z-[1005] bg-black/90 hidden items-center justify-center p-4 backdrop-blur-md">
        <div class="glass-card p-6 rounded-3xl w-full max-w-sm">
            <h2 class="text-lg font-extrabold mb-4 text-blue-400 uppercase italic">Edit Produk</h2>
            <div class="space-y-3">
                <input type="text" id="editNama" class="w-full p-4 rounded-xl font-bold uppercase text-sm">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="editEcer" oninput="formatMoneyInput(this)" class="p-4 rounded-xl font-mono-price text-sm" placeholder="Ecer">
                    <input type="text" id="editGrosir" oninput="formatMoneyInput(this)" class="p-4 rounded-xl font-mono-price text-sm" placeholder="Box">
                </div>
                <input type="number" id="editStok" class="w-full p-4 rounded-xl font-bold text-sm" placeholder="Stok">
                <div class="flex gap-2 pt-2">
                    <button onclick="closeEditModal()" class="flex-1 py-4 text-slate-400 text-[10px] font-bold uppercase">Batal</button>
                    <button onclick="updateBarang()" class="flex-[2] bg-blue-600 py-4 rounded-xl font-bold text-xs">SIMPAN</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-add-barang" class="fixed inset-0 z-[1005] bg-black/90 hidden items-center justify-center p-4 backdrop-blur-md">
        <div class="glass-card p-6 rounded-3xl w-full max-w-sm">
            <h2 class="text-lg font-extrabold mb-4 text-blue-400 uppercase italic">Produk Baru</h2>
            <div class="space-y-3" id="admForm">
                <input type="text" id="admNama" placeholder="NAMA BARANG" class="w-full p-4 rounded-xl text-xs font-black uppercase">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="admEcer" oninput="formatMoneyInput(this)" placeholder="HARGA ECER" class="w-full p-4 rounded-xl font-mono-price text-sm">
                    <input type="text" id="admGrosir" oninput="formatMoneyInput(this)" placeholder="HARGA BOX" class="w-full p-4 rounded-xl font-mono-price text-sm">
                </div>
                <input type="number" id="admStok" placeholder="STOK AWAL" class="w-full p-4 rounded-xl font-bold text-sm">
                <div class="flex gap-2 pt-2">
                    <button onclick="document.getElementById('modal-add-barang').classList.replace('flex','hidden')" class="flex-1 py-4 text-slate-400 text-[10px] font-bold uppercase">Batal</button>
                    <button onclick="simpanBarangMobile()" class="flex-[2] bg-blue-600 py-4 rounded-xl font-bold text-xs uppercase">Simpan Produk</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-pass" class="fixed inset-0 z-[1001] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-xs text-center">
            <h2 class="text-xs font-bold mb-4 text-white uppercase tracking-widest">PIN Admin</h2>
            <input type="password" id="admin-pass-input" pattern="\d*" inputmode="numeric" class="w-full p-4 rounded-2xl mb-6 text-center text-2xl font-bold tracking-[0.5em]">
            <button onclick="checkAdminPass()" class="w-full bg-blue-600 py-4 rounded-2xl font-bold uppercase text-xs">Akses Admin</button>
            <button onclick="closePassModal()" class="mt-4 text-[9px] text-slate-500 font-bold uppercase">Kembali</button>
        </div>
    </div>

    <div id="modal-print-confirm" class="fixed inset-0 z-[1010] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl">üñ®Ô∏è</span></div>
            <h2 class="text-xl font-black text-white uppercase mb-1">Berhasil!</h2>
            <p class="text-slate-400 font-bold text-[10px] mb-6 uppercase tracking-widest">Cetak struk belanja?</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="handlePrintDecision(true)" class="bg-blue-600 py-4 rounded-2xl font-black uppercase text-xs">YA</button>
                <button onclick="handlePrintDecision(false)" class="bg-white/5 py-4 rounded-2xl font-black uppercase text-xs border border-white/10">TIDAK</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG FIREBASE (Sesuai kode awal Anda)
        const config = {
            apiKey: "AIzaSyBhrN6vuBzuxwFgPI-iXJky6ErDz8auclY",
            authDomain: "toko4malia.firebaseapp.com",
            projectId: "toko4malia",
            storageBucket: "toko4malia.firebasestorage.app",
            messagingSenderId: "1053922856540",
            appId: "1:1053922856540:web:34f5e6de7d5538b1e66099"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();

        let dataBarang = [], dataTransaksi = [], keranjang = [], userAktif = '', userRole = '', editingId = null;
        let lastTransactionId = null;

        const formatIDR = (n) => new Intl.NumberFormat('id-ID').format(n || 0);
        const toNum = (s) => parseInt(s?.toString().replace(/[^0-9]/g, '')) || 0;

        function formatMoneyInput(el) {
            let v = toNum(el.value);
            el.value = v === 0 ? "" : formatIDR(v);
        }

        function toast(msg, type = 'blue') {
            const t = document.getElementById('toast');
            const txt = document.getElementById('toast-text');
            const ico = document.getElementById('toast-icon');
            const inner = document.getElementById('toast-inner');
            inner.style.borderColor = type === 'red' ? '#ef4444' : '#3b82f6';
            ico.innerHTML = type === 'red' ? '‚ö†Ô∏è' : '‚úÖ';
            txt.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function attemptLogin(role) {
            const name = document.getElementById('inNamaUser').value;
            if(!name) return toast("Isi Nama!", "red");
            if(role === 'Admin') document.getElementById('modal-pass').classList.replace('hidden', 'flex');
            else loginSuccess(name, 'Kasir');
        }

        function checkAdminPass() {
            if(document.getElementById('admin-pass-input').value === '1212') {
                loginSuccess(document.getElementById('inNamaUser').value, 'Admin');
                closePassModal();
            } else { toast("PIN SALAH!", "red"); }
        }

        function loginSuccess(name, role) {
            userAktif = name; userRole = role;
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('user-info').innerText = name;
            document.getElementById('role-info').innerText = role;
            if(role === 'Admin') document.getElementById('nav-admin').classList.remove('hidden');
            showSection('kasir'); syncData();
        }

        function closePassModal() { document.getElementById('modal-pass').classList.replace('flex', 'hidden'); }

        function syncData() {
            db.collection("barang").onSnapshot(snap => {
                dataBarang = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAdminTable();
            });
            db.collection("transaksi").orderBy("waktu", "desc").onSnapshot(snap => {
                dataTransaksi = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderHistory(); updateLaporan();
            });
        }

        function showSection(id) {
            document.querySelectorAll('.section-page').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const b = document.getElementById('nav-' + id);
            if(b) b.classList.add('active');
        }

        // --- KASIR LOGIC ---
        function searchBarang(val) {
            const list = document.getElementById('dropdownSearch');
            if(!val) return list.classList.add('hidden');
            const res = dataBarang.filter(b => b.nama.toLowerCase().includes(val.toLowerCase()));
            list.innerHTML = res.map(b => `
                <div onclick="addToCart('${b.id}')" class="p-4 border-b border-white/5 flex justify-between items-center active:bg-white/10">
                    <div class="pr-2"><p class="font-black text-white uppercase text-xs">${b.nama}</p>
                    <div class="mt-1"><span class="badge-stok ${b.stok < 5 ? 'badge-stok-low' : ''}" style="font-size:8px;">STOK: ${b.stok}</span></div></div>
                    <p class="font-mono-price text-blue-400 font-black text-xs shrink-0">Rp${formatIDR(b.harga)}</p>
                </div>
            `).join('');
            list.classList.toggle('hidden', res.length === 0);
        }

        function addToCart(id) {
            const b = dataBarang.find(x => x.id === id);
            if(b.stok <= 0) return toast("Stok Habis!", "red");
            const ex = keranjang.find(k => k.id === id && k.unit === 'PCS');
            if(ex) { ex.qty++; ex.sub = ex.qty * ex.harga; }
            else { keranjang.push({...b, qty:1, unit:'PCS', sub:b.harga}); }
            renderCart(); 
            document.getElementById('dropdownSearch').classList.add('hidden');
            document.getElementById('inCari').value = "";
        }

        function renderCart() {
            let subtotalSemua = 0;
            document.getElementById('tabelKasir').innerHTML = keranjang.map((i, idx) => {
                subtotalSemua += i.sub;
                return `<tr>
                    <td class="p-3">
                        <p class="font-black text-white uppercase" style="font-size:11px;">${i.nama}</p>
                        <p class="text-[8px] font-bold text-blue-400">@ ${formatIDR(i.unit==='BOX'?i.hargaBox:i.harga)}</p>
                    </td>
                    <td class="p-3">
                        <div class="flex flex-col items-center gap-1">
                            <input type="number" value="${i.qty}" onchange="updQty(${idx}, this.value)" class="w-10 bg-slate-900 border-none rounded p-1 text-center font-bold text-yellow-400 text-[10px]">
                            <button onclick="toggleUnit(${idx})" class="text-[7px] font-black px-2 py-0.5 rounded ${i.unit==='BOX'?'bg-orange-600':'bg-blue-600'} text-white">${i.unit}</button>
                        </div>
                    </td>
                    <td class="p-3 text-right font-mono-price text-white font-black">Rp${formatIDR(i.sub)}</td>
                    <td class="p-3 text-center"><button onclick="keranjang.splice(${idx},1);renderCart()" class="text-red-500">‚úï</button></td>
                </tr>`;
            }).join('');
            const diskon = toNum(document.getElementById('diskonManual').value);
            document.getElementById('totalBelanja').innerText = "Rp " + formatIDR(Math.max(0, subtotalSemua - diskon));
            hitungKembali();
        }

        function updQty(idx, v) { 
            keranjang[idx].qty = Math.max(1, parseInt(v)||1); 
            keranjang[idx].sub = (keranjang[idx].unit==='BOX'?keranjang[idx].hargaBox:keranjang[idx].harga) * keranjang[idx].qty;
            renderCart(); 
        }

        function toggleUnit(idx) {
            keranjang[idx].unit = keranjang[idx].unit==='PCS'?'BOX':'PCS';
            keranjang[idx].sub = (keranjang[idx].unit==='BOX'?keranjang[idx].hargaBox:keranjang[idx].harga) * keranjang[idx].qty;
            renderCart();
        }

        function hitungKembali() {
            const t = toNum(document.getElementById('totalBelanja').innerText);
            const b = toNum(document.getElementById('bayarTunai').value);
            const selisih = Math.max(0, b - t);
            document.getElementById('kembalianText').innerText = "Rp " + formatIDR(selisih);
        }

        async function prosesBayar() {
            const t = toNum(document.getElementById('totalBelanja').innerText);
            const b = toNum(document.getElementById('bayarTunai').value);
            const diskon = toNum(document.getElementById('diskonManual').value);
            if(keranjang.length === 0) return toast("Keranjang Kosong!", "red");
            if(b < t) return toast("Tunai Kurang!", "red");

            try {
                const docRef = await db.collection("transaksi").add({
                    kasir: userAktif, total: t, bayar: b, kembali: b-t, diskon: diskon,
                    waktu: firebase.firestore.FieldValue.serverTimestamp(),
                    items: keranjang.map(i => ({nama:i.nama, qty:i.qty, sub:i.sub, unit:i.unit, hrg:i.unit==='BOX'?i.hargaBox:i.harga}))
                });
                lastTransactionId = docRef.id;
                for(let i of keranjang) {
                    const dec = i.unit === 'BOX' ? i.qty * 12 : i.qty;
                    const ref = db.collection("barang").doc(i.id);
                    await db.runTransaction(async (transaction) => {
                        const d = await transaction.get(ref);
                        transaction.update(ref, {stok: d.data().stok - dec});
                    });
                }
                document.getElementById('modal-print-confirm').classList.replace('hidden', 'flex');
            } catch(e) { toast("ERROR: " + e.message, "red"); }
        }

        function handlePrintDecision(shouldPrint) {
            document.getElementById('modal-print-confirm').classList.replace('flex', 'hidden');
            if(shouldPrint && lastTransactionId) printStruk(lastTransactionId);
            toast("TRANSAKSI BERHASIL!");
            resetKasir();
        }

        function resetKasir() {
            keranjang=[]; 
            document.getElementById('bayarTunai').value=""; 
            document.getElementById('diskonManual').value=""; 
            renderCart();
        }

        function printStruk(id) {
            const t = dataTransaksi.find(x => x.id === id);
            if(!t) return;
            const printArea = document.getElementById('print-area');
            const d = t.waktu?.toDate() || new Date();
            const dateStr = d.toLocaleDateString('id-ID') + ' ' + d.toLocaleTimeString('id-ID');
            
            printArea.innerHTML = `
                <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:5px; margin-bottom:5px;">
                    <b style="font-size:14px">AMALIA STORE</b><br>Mobile POS System
                </div>
                <div style="margin-bottom:5px; font-size:10px">
                    Kasir: ${t.kasir}<br>${dateStr}
                </div>
                <table style="width:100%; border-bottom:1px dashed #000; margin-bottom:5px; font-size:10px;">
                    ${t.items.map(i => `
                        <tr><td colspan="2">${i.nama}</td></tr>
                        <tr><td>${i.qty} ${i.unit} x ${formatIDR(i.hrg)}</td><td style="text-align:right">${formatIDR(i.sub)}</td></tr>
                    `).join('')}
                </table>
                <table style="width:100%; font-size:10px;">
                    ${t.diskon ? `<tr><td>Diskon</td><td style="text-align:right">-${formatIDR(t.diskon)}</td></tr>` : ''}
                    <tr><td><b>TOTAL</b></td><td style="text-align:right"><b>${formatIDR(t.total)}</b></td></tr>
                    <tr><td>Tunai</td><td style="text-align:right">${formatIDR(t.bayar)}</td></tr>
                    <tr><td>Kembali</td><td style="text-align:right">${formatIDR(t.kembali)}</td></tr>
                </table>
                <div style="text-align:center; margin-top:10px; border-top:1px dashed #000; padding-top:5px; font-size:10px;">Terima Kasih Atas Kunjungannya</div>
            `;
            window.print();
        }

        // --- ADMIN & HISTORY LOGIC (MOBILE OPTIMIZED) ---
        function renderAdminTable(f = '') {
            const res = dataBarang.filter(b => b.nama.toLowerCase().includes(f.toLowerCase()));
            const container = document.getElementById('tabelAdminMobile');
            container.innerHTML = res.map(b => `
                <div class="glass-card p-4 rounded-2xl flex justify-between items-center border-l-4 ${b.stok < 10 ? 'border-red-500' : 'border-blue-500'}">
                    <div>
                        <p class="font-black text-white text-xs uppercase">${b.nama}</p>
                        <div class="flex gap-2 mt-1">
                            <span class="text-[9px] text-blue-400 font-bold">E: ${formatIDR(b.harga)}</span>
                            <span class="text-[9px] text-orange-400 font-bold">B: ${formatIDR(b.hargaBox)}</span>
                        </div>
                        <span class="badge-stok ${b.stok < 10 ? 'badge-stok-low' : ''} mt-1">Stok: ${b.stok}</span>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="openEdit('${b.id}')" class="w-10 h-10 bg-white/5 rounded-full flex items-center justify-center text-blue-400">‚úé</button>
                        <button onclick="deleteBarang('${b.id}')" class="w-10 h-10 bg-white/5 rounded-full flex items-center justify-center text-red-500">üóë</button>
                    </div>
                </div>
            `).join('');
        }

        async function simpanBarangMobile() {
            const d = { 
                nama: document.getElementById('admNama').value.toUpperCase(),
                harga: toNum(document.getElementById('admEcer').value),
                hargaBox: toNum(document.getElementById('admGrosir').value),
                stok: parseInt(document.getElementById('admStok').value) || 0
            };
            if(!d.nama || !d.harga) return toast("Lengkapi Data!", "red");
            await db.collection("barang").add(d);
            document.querySelectorAll('#admForm input').forEach(i => i.value="");
            document.getElementById('modal-add-barang').classList.replace('flex','hidden');
            toast("PRODUK DISIMPAN!");
        }

        function openEdit(id) {
            editingId = id; const b = dataBarang.find(x => x.id === id);
            document.getElementById('editNama').value = b.nama;
            document.getElementById('editEcer').value = formatIDR(b.harga);
            document.getElementById('editGrosir').value = formatIDR(b.hargaBox);
            document.getElementById('editStok').value = b.stok;
            document.getElementById('modal-edit').classList.replace('hidden', 'flex');
        }

        async function updateBarang() {
            await db.collection("barang").doc(editingId).update({
                nama: document.getElementById('editNama').value.toUpperCase(),
                harga: toNum(document.getElementById('editEcer').value),
                hargaBox: toNum(document.getElementById('editGrosir').value),
                stok: parseInt(document.getElementById('editStok').value) || 0
            });
            closeEditModal(); toast("UPDATE BERHASIL!");
        }

        function closeEditModal() { document.getElementById('modal-edit').classList.replace('flex', 'hidden'); }
        async function deleteBarang(id) { if(confirm('Hapus produk ini?')) await db.collection("barang").doc(id).delete(); }

        function renderHistory() {
            document.getElementById('history-list').innerHTML = dataTransaksi.map(t => {
                const dateObj = t.waktu?.toDate();
                const formattedDate = dateObj ? dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }) : '-';
                const formattedTime = dateObj ? dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';

                return `
                <div class="glass-card p-4 rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-600"></div>
                    <div class="flex justify-between items-start mb-2 pb-2 border-b border-white/5">
                        <div>
                            <p class="text-[8px] text-blue-400 font-bold uppercase tracking-widest">${t.kasir}</p>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">${formattedDate} ‚Ä¢ ${formattedTime}</p>
                        </div>
                        <button onclick="printStruk('${t.id}')" class="bg-blue-600/20 text-blue-400 p-2 rounded-lg text-[9px] font-black uppercase">STRUK üñ®Ô∏è</button>
                    </div>
                    <div class="space-y-1 mb-3">
                        ${t.items.slice(0,2).map(i => `
                            <div class="flex justify-between text-[9px] text-white/70">
                                <span>${i.nama} x ${i.qty}</span>
                                <span>Rp${formatIDR(i.sub)}</span>
                            </div>
                        `).join('')}
                        ${t.items.length > 2 ? `<p class="text-[8px] text-slate-500 italic">+ ${t.items.length - 2} item lainnya</p>` : ''}
                    </div>
                    <div class="flex justify-between items-center bg-white/5 p-2 rounded-xl">
                        <span class="text-[8px] text-slate-400 font-black uppercase">Total Akhir</span>
                        <span class="font-mono-price text-sm font-black text-white">Rp${formatIDR(t.total)}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function updateLaporan() {
            const total = dataTransaksi.reduce((a, b) => a + (b.total || 0), 0);
            document.getElementById('omzet-all').innerText = "Rp " + formatIDR(total);
            document.getElementById('all-count-total').innerText = dataTransaksi.length;
            filterLaporan();
        }

        function filterLaporan() {
            const d = document.getElementById('pick-day').value;
            let f = dataTransaksi;
            if(d) f = dataTransaksi.filter(t => t.waktu?.toDate().toISOString().split('T')[0] === d);
            const total = f.reduce((a,b) => a + (b.total||0), 0);
            document.getElementById('lap-omzet').innerText = "Rp " + formatIDR(total);
            document.getElementById('lap-count').innerText = f.length;
        }

        // Shortcut F8 (tetap ada tapi keyboard HP mungkin berbeda)
        window.addEventListener('keydown', (e) => { if(e.key === 'F8') document.getElementById('bayarTunai').focus(); });
    </script>
</body>
</html>
