<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMALIA POS PRO - Multi Device</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #3b82f6; --bg: #020617; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            color: #f8fafc; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            margin: 0; 
        }
        
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .font-mono-price { font-family: 'JetBrains Mono', monospace; }
        
        .custom-scroll { overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(59, 130, 246, 0.3) transparent; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.3); border-radius: 10px; }

        .badge-stok { background: #facc15; color: #000; padding: 2px 8px; border-radius: 6px; font-weight: 800; font-size: 10px; }
        .badge-stok-low { background: #ef4444; color: white; }

        .nav-btn { 
            transition: 0.3s; 
            color: #94a3b8; 
            font-weight: 700; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            flex: 1;
            font-size: 10px;
        }
        .nav-btn.active { color: #3b82f6; }

        #toast { position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%) scale(0.5); z-index: 9999; opacity: 0; visibility: hidden; transition: 0.4s; width: 90%; max-width: 320px; }
        #toast.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }

        input, button { touch-action: manipulation; min-height: 44px; }
        input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1); color: white; outline: none; padding: 0 12px; }
        
        /* Mobile Specific Adjustment */
        @media (max-width: 768px) {
            .section-page { height: calc(100vh - 130px); padding-bottom: 80px; }
            .hide-mobile { display: none; }
            table { font-size: 11px; }
            td, th { padding: 8px 4px !important; }
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 58mm; color: black; }
        }
    </style>
</head>
<body>

    <div id="print-area" class="hidden font-mono text-[10px] w-[58mm]"></div>

    <div id="toast">
        <div id="toast-inner" class="glass-card px-6 py-4 rounded-2xl border-t-4 border-blue-500 shadow-2xl text-center">
            <div id="toast-icon" class="text-2xl mb-1"></div>
            <div id="toast-text" class="text-xs font-black uppercase text-white"></div>
        </div>
    </div>

    <div id="login-page" class="fixed inset-0 z-[1000] bg-[#020617] flex items-center justify-center p-6">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-xs text-center">
            <h1 class="text-4xl font-black italic text-blue-500 mb-1">AMALIA</h1>
            <p class="text-[8px] font-bold text-slate-500 uppercase tracking-[0.3em] mb-8">Point of Sale</p>
            <input type="text" id="inNamaUser" placeholder="NAMA PETUGAS" class="w-full rounded-2xl text-center font-black uppercase mb-4">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="attemptLogin('Kasir')" class="bg-white/5 rounded-xl font-bold text-[10px] uppercase">KASIR</button>
                <button onclick="attemptLogin('Admin')" class="bg-blue-600 rounded-xl font-bold text-[10px] uppercase">ADMIN</button>
            </div>
        </div>
    </div>

    <header class="p-4 flex justify-between items-center glass-card border-b border-white/5 z-50">
        <div class="flex items-center gap-2">
            <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center font-black italic text-white text-sm">A</div>
            <h1 class="text-sm font-black italic text-white">AMALIA</h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right">
                <p id="user-info" class="text-[9px] font-black uppercase text-white leading-none"></p>
                <p id="role-info" class="text-[7px] font-bold text-blue-500 uppercase"></p>
            </div>
            <button onclick="location.reload()" class="text-red-500 font-bold text-lg px-2">‚úï</button>
        </div>
    </header>

    <main id="main-container" class="flex-grow overflow-hidden relative">
        
        <div id="sec-kasir" class="section-page h-full flex flex-col lg:flex-row">
            <div class="flex-grow flex flex-col p-3 overflow-hidden">
                <div class="relative mb-3">
                    <input type="text" id="inCari" oninput="searchBarang(this.value)" placeholder="Cari Produk..." class="w-full rounded-xl font-bold">
                    <div id="dropdownSearch" class="absolute top-full left-0 right-0 glass-card rounded-xl mt-1 z-[100] max-h-[60vh] overflow-y-auto custom-scroll hidden shadow-2xl"></div>
                </div>
                
                <div class="glass-card rounded-2xl flex-grow flex flex-col overflow-hidden">
                    <div class="overflow-y-auto flex-grow custom-scroll">
                        <table class="w-full text-left">
                            <thead class="bg-slate-900/80 sticky top-0 text-[10px] font-bold uppercase text-slate-500">
                                <tr>
                                    <th class="p-3">Item</th>
                                    <th class="p-3 text-center">Qty</th>
                                    <th class="p-3 text-right">Sub</th>
                                    <th class="p-3"></th>
                                </tr>
                            </thead>
                            <tbody id="tabelKasir" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="side-panel" class="w-full lg:w-80 p-3 glass-card border-t lg:border-t-0 lg:border-l border-white/10 flex flex-col gap-2 shrink-0">
                <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-3 rounded-xl">
                    <p class="text-[8px] font-bold uppercase opacity-70">Total Belanja</p>
                    <h1 id="totalBelanja" class="text-xl font-black font-mono-price">Rp 0</h1>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="p-2 bg-white/5 rounded-lg border border-white/5">
                        <label class="text-[8px] font-bold text-slate-400 uppercase block">Diskon</label>
                        <input type="text" id="diskonManual" oninput="formatMoneyInput(this); renderCart()" class="w-full bg-transparent text-xs font-bold text-orange-400 p-0 min-h-0 h-6" placeholder="0">
                    </div>
                    <div class="p-2 bg-white/5 rounded-lg border border-white/5">
                        <label class="text-[8px] font-bold text-slate-400 uppercase block">Tunai</label>
                        <input type="text" id="bayarTunai" oninput="formatMoneyInput(this); hitungKembali()" class="w-full bg-transparent text-xs font-black text-blue-400 p-0 min-h-0 h-6" placeholder="0">
                    </div>
                </div>

                <div class="p-2 bg-slate-900/50 rounded-lg flex justify-between items-center">
                    <span class="text-[8px] text-slate-500 font-bold uppercase">Kembali</span>
                    <span id="kembalianText" class="text-xs font-black text-green-400 font-mono-price">Rp 0</span>
                </div>
                <button onclick="prosesBayar()" class="w-full bg-blue-600 py-3 rounded-xl font-black text-xs uppercase shadow-lg shadow-blue-500/20">Bayar Sekarang</button>
            </div>
        </div>

        <div id="sec-history" class="section-page hidden h-full overflow-y-auto custom-scroll p-4">
            <div class="max-w-md mx-auto space-y-3" id="history-list"></div>
        </div>

        <div id="sec-laporan" class="section-page hidden h-full overflow-y-auto custom-scroll p-4">
            <div class="max-w-md mx-auto space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="glass-card p-4 rounded-xl border-l-4 border-blue-500">
                        <p class="text-[8px] text-blue-400 font-black uppercase text-center">Total Omzet</p>
                        <h1 id="omzet-all" class="text-sm font-black font-mono-price text-center">Rp 0</h1>
                    </div>
                    <div class="glass-card p-4 rounded-xl border-l-4 border-emerald-500">
                        <p class="text-[8px] text-slate-500 font-black uppercase text-center">Transaksi</p>
                        <h1 id="all-count-total" class="text-sm font-black text-center">0</h1>
                    </div>
                </div>
                <div class="glass-card p-4 rounded-xl space-y-3">
                    <div class="flex gap-2">
                        <input type="date" id="pick-day" onchange="filterLaporan()" class="flex-1 rounded-lg text-[10px] font-bold bg-white/5 h-10">
                        <input type="month" id="pick-month" onchange="filterLaporan()" class="flex-1 rounded-lg text-[10px] font-bold bg-white/5 h-10">
                    </div>
                    <div class="border-t border-white/5 pt-3 flex justify-between items-center">
                        <p class="text-[9px] text-yellow-500 uppercase font-bold">Filter: <span id="lap-count" class="text-white">0</span> Trx</p>
                        <h2 id="lap-omzet" class="text-sm font-black font-mono-price">Rp 0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-admin" class="section-page hidden h-full overflow-y-auto p-4">
            <div class="max-w-md mx-auto space-y-6">
                <div class="glass-card p-5 rounded-2xl">
                    <h2 class="text-xs font-black uppercase mb-4 italic text-blue-400">Tambah / Edit Barang</h2>
                    <div class="grid grid-cols-1 gap-2" id="admForm">
                        <input type="text" id="admNama" placeholder="NAMA BARANG" class="w-full rounded-lg text-[10px] font-black uppercase">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="admEcer" oninput="formatMoneyInput(this)" placeholder="HARGA ECER" class="w-full rounded-lg text-[10px] font-mono-price">
                            <input type="text" id="admGrosir" oninput="formatMoneyInput(this)" placeholder="HARGA BOX" class="w-full rounded-lg text-[10px] font-mono-price">
                        </div>
                        <input type="number" id="admStok" placeholder="STOK AWAL" class="w-full rounded-lg text-[10px] font-bold">
                        <button onclick="simpanBarang()" class="w-full bg-blue-600 rounded-lg font-bold uppercase text-[10px]">Simpan ke Database</button>
                    </div>
                </div>

                <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="p-3 border-b border-white/5">
                        <input type="text" oninput="renderAdminTable(this.value)" placeholder="CARI DATABASE..." class="w-full rounded-lg text-[9px] font-bold uppercase h-9">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-[9px]">
                            <thead class="bg-slate-900/50 text-slate-500 font-bold uppercase">
                                <tr><th class="p-3">Nama</th><th class="p-3">Ecer</th><th class="p-3">Stok</th><th class="p-3"></th></tr>
                            </thead>
                            <tbody id="tabelAdmin" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <nav id="main-nav" class="hidden glass-card border-t border-white/10 h-16 flex items-center justify-around px-2 z-[100]">
        <button id="nav-kasir" onclick="showSection('kasir')" class="nav-btn active">
            <span class="text-lg">üõí</span>
            <span>KASIR</span>
        </button>
        <button id="nav-history" onclick="showSection('history')" class="nav-btn">
            <span class="text-lg">üïí</span>
            <span>HISTORY</span>
        </button>
        <button id="nav-laporan" onclick="showSection('laporan')" class="nav-btn">
            <span class="text-lg">üìä</span>
            <span>LAPORAN</span>
        </button>
        <button id="nav-admin" onclick="showSection('admin')" class="nav-btn hidden !text-orange-400">
            <span class="text-lg">‚öôÔ∏è</span>
            <span>ADMIN</span>
        </button>
    </nav>

    <div id="modal-print-confirm" class="fixed inset-0 z-[1010] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-xs text-center">
            <h2 class="text-xl font-black text-white uppercase mb-4">BERHASIL!</h2>
            <p class="text-slate-400 font-bold text-xs mb-6 uppercase">Cetak Struk?</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="handlePrintDecision(true)" class="bg-blue-600 rounded-2xl font-black uppercase text-sm">YA</button>
                <button onclick="handlePrintDecision(false)" class="bg-white/5 rounded-2xl font-black uppercase text-sm">TIDAK</button>
            </div>
        </div>
    </div>

    <div id="modal-pass" class="fixed inset-0 z-[1001] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-card p-8 rounded-[35px] w-full max-w-xs text-center">
            <h2 class="text-xs font-bold mb-4 text-white uppercase tracking-widest">PIN Admin</h2>
            <input type="password" id="admin-pass-input" class="w-full rounded-xl mb-4 text-center text-2xl font-bold tracking-[0.5em]">
            <button onclick="checkAdminPass()" class="w-full bg-blue-600 rounded-xl font-bold uppercase text-xs">Akses</button>
            <button onclick="closePassModal()" class="mt-4 text-[8px] text-slate-500 font-bold uppercase block w-full">Kembali</button>
        </div>
    </div>

    <div id="modal-edit" class="fixed inset-0 z-[1005] bg-black/80 hidden items-center justify-center p-6 backdrop-blur-md">
        <div class="glass-card p-6 rounded-3xl w-full max-w-sm">
            <h2 class="text-sm font-black mb-4 text-blue-400 uppercase italic">Edit Item</h2>
            <div class="space-y-3">
                <input type="text" id="editNama" class="w-full rounded-xl font-bold uppercase text-xs h-12">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="editEcer" oninput="formatMoneyInput(this)" class="rounded-xl text-xs font-mono-price h-12" placeholder="Ecer">
                    <input type="text" id="editGrosir" oninput="formatMoneyInput(this)" class="rounded-xl text-xs font-mono-price h-12" placeholder="Box">
                </div>
                <input type="number" id="editStok" class="w-full rounded-xl font-bold text-xs h-12" placeholder="Stok">
                <button onclick="updateBarang()" class="w-full bg-blue-600 rounded-xl font-bold text-xs uppercase h-12">Simpan Perubahan</button>
                <button onclick="closeEditModal()" class="w-full py-2 text-slate-500 text-[9px] uppercase font-bold">Batal</button>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE & LOGIC TETAP SAMA NAMUN DENGAN PENYESUAIAN RENDER UNTUK MOBILE
        const config = {
            apiKey: "AIzaSyBhrN6vuBzuxwFgPI-iXJky6ErDz8auclY",
            authDomain: "toko4malia.firebaseapp.com",
            projectId: "toko4malia",
            storageBucket: "toko4malia.firebasestorage.app",
            messagingSenderId: "1053922856540",
            appId: "1:1053922856540:web:34f5e6de7d5538b1e66099"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();

        let dataBarang = [], dataTransaksi = [], keranjang = [], userAktif = '', userRole = '', editingId = null, lastTransactionId = null;

        const formatIDR = (n) => new Intl.NumberFormat('id-ID').format(n || 0);
        const toNum = (s) => parseInt(s?.toString().replace(/[^0-9]/g, '')) || 0;

        function formatMoneyInput(el) {
            let v = toNum(el.value);
            el.value = v === 0 ? "" : formatIDR(v);
        }

        function toast(msg, type = 'blue') {
            const t = document.getElementById('toast');
            const txt = document.getElementById('toast-text');
            const ico = document.getElementById('toast-icon');
            const inner = document.getElementById('toast-inner');
            inner.style.borderColor = type === 'red' ? '#ef4444' : '#3b82f6';
            ico.innerHTML = type === 'red' ? '‚ö†Ô∏è' : '‚úÖ';
            txt.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        function attemptLogin(role) {
            const name = document.getElementById('inNamaUser').value;
            if(!name) return toast("Isi Nama!", "red");
            if(role === 'Admin') document.getElementById('modal-pass').classList.replace('hidden', 'flex');
            else loginSuccess(name, 'Kasir');
        }

        function checkAdminPass() {
            if(document.getElementById('admin-pass-input').value === '1212') {
                loginSuccess(document.getElementById('inNamaUser').value, 'Admin');
                closePassModal();
            } else { toast("PIN SALAH!", "red"); }
        }

        function loginSuccess(name, role) {
            userAktif = name; userRole = role;
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-nav').classList.replace('hidden', 'flex');
            document.getElementById('user-info').innerText = name;
            document.getElementById('role-info').innerText = role;
            if(role === 'Admin') document.getElementById('nav-admin').classList.remove('hidden');
            showSection('kasir'); syncData();
        }

        function closePassModal() { document.getElementById('modal-pass').classList.replace('flex', 'hidden'); }

        function syncData() {
            db.collection("barang").onSnapshot(snap => {
                dataBarang = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAdminTable();
            });
            db.collection("transaksi").orderBy("waktu", "desc").onSnapshot(snap => {
                dataTransaksi = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderHistory(); updateLaporan();
            });
        }

        function showSection(id) {
            document.querySelectorAll('.section-page').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const b = document.getElementById('nav-' + id);
            if(b) b.classList.add('active');
        }

        function searchBarang(val) {
            const list = document.getElementById('dropdownSearch');
            if(!val) return list.classList.add('hidden');
            const res = dataBarang.filter(b => b.nama.toLowerCase().includes(val.toLowerCase()));
            list.innerHTML = res.map(b => `
                <div onclick="addToCart('${b.id}')" class="p-3 border-b border-white/5 cursor-pointer hover:bg-white/10 flex justify-between items-center">
                    <div>
                        <p class="font-black text-white uppercase text-[10px]">${b.nama}</p>
                        <span class="badge-stok ${b.stok < 5 ? 'badge-stok-low' : ''}">STOK: ${b.stok}</span>
                    </div>
                    <p class="font-mono-price text-blue-400 font-black text-xs">Rp${formatIDR(b.harga)}</p>
                </div>
            `).join('');
            list.classList.toggle('hidden', res.length === 0);
        }

        function addToCart(id) {
            const b = dataBarang.find(x => x.id === id);
            if(b.stok <= 0) return toast("Stok Habis!", "red");
            const ex = keranjang.find(k => k.id === id && k.unit === 'PCS');
            if(ex) { ex.qty++; ex.sub = ex.qty * ex.harga; }
            else { keranjang.push({...b, qty:1, unit:'PCS', sub:b.harga}); }
            renderCart(); 
            document.getElementById('dropdownSearch').classList.add('hidden');
            document.getElementById('inCari').value = "";
        }

        function renderCart() {
            let subtotalSemua = 0;
            document.getElementById('tabelKasir').innerHTML = keranjang.map((i, idx) => {
                subtotalSemua += i.sub;
                return `<tr>
                    <td class="p-3">
                        <p class="font-black text-white uppercase text-[10px] leading-tight">${i.nama}</p>
                        <p class="text-[8px] text-blue-400">@${formatIDR(i.unit==='BOX'?i.hargaBox:i.harga)}</p>
                    </td>
                    <td class="p-3 text-center">
                        <div class="flex flex-col items-center gap-1">
                            <input type="number" value="${i.qty}" onchange="updQty(${idx}, this.value)" class="w-10 bg-slate-900 rounded p-1 text-center font-bold text-yellow-400 text-[10px] min-h-0 h-7">
                            <button onclick="toggleUnit(${idx})" class="text-[7px] font-black px-2 py-1 rounded ${i.unit==='BOX'?'bg-orange-600':'bg-blue-600'} text-white h-auto min-h-0">${i.unit}</button>
                        </div>
                    </td>
                    <td class="p-3 text-right font-mono-price text-white font-bold text-[10px]">Rp${formatIDR(i.sub)}</td>
                    <td class="p-3 text-center"><button onclick="keranjang.splice(${idx},1);renderCart()" class="text-red-500">‚úï</button></td>
                </tr>`;
            }).join('');
            const diskon = toNum(document.getElementById('diskonManual').value);
            document.getElementById('totalBelanja').innerText = "Rp " + formatIDR(Math.max(0, subtotalSemua - diskon));
            hitungKembali();
        }

        function updQty(idx, v) { 
            keranjang[idx].qty = Math.max(1, parseInt(v)||1); 
            keranjang[idx].sub = (keranjang[idx].unit==='BOX'?keranjang[idx].hargaBox:keranjang[idx].harga) * keranjang[idx].qty;
            renderCart(); 
        }

        function toggleUnit(idx) {
            keranjang[idx].unit = keranjang[idx].unit==='PCS'?'BOX':'PCS';
            keranjang[idx].sub = (keranjang[idx].unit==='BOX'?keranjang[idx].hargaBox:keranjang[idx].harga) * keranjang[idx].qty;
            renderCart();
        }

        function hitungKembali() {
            const t = toNum(document.getElementById('totalBelanja').innerText);
            const b = toNum(document.getElementById('bayarTunai').value);
            document.getElementById('kembalianText').innerText = "Rp " + formatIDR(Math.max(0, b - t));
        }

        async function prosesBayar() {
            const t = toNum(document.getElementById('totalBelanja').innerText);
            const b = toNum(document.getElementById('bayarTunai').value);
            const diskon = toNum(document.getElementById('diskonManual').value);
            if(keranjang.length === 0) return toast("Keranjang Kosong!", "red");
            if(b < t) return toast("Tunai Kurang!", "red");
            try {
                const docRef = await db.collection("transaksi").add({
                    kasir: userAktif, total: t, bayar: b, kembali: b-t, diskon: diskon,
                    waktu: firebase.firestore.FieldValue.serverTimestamp(),
                    items: keranjang.map(i => ({nama:i.nama, qty:i.qty, sub:i.sub, unit:i.unit, hrg:i.unit==='BOX'?i.hargaBox:i.harga}))
                });
                lastTransactionId = docRef.id;
                for(let i of keranjang) {
                    const dec = i.unit === 'BOX' ? i.qty * 12 : i.qty;
                    const ref = db.collection("barang").doc(i.id);
                    await db.runTransaction(async (transaction) => {
                        const d = await transaction.get(ref);
                        transaction.update(ref, {stok: d.data().stok - dec});
                    });
                }
                document.getElementById('modal-print-confirm').classList.replace('hidden', 'flex');
            } catch(e) { toast("ERROR", "red"); }
        }

        function handlePrintDecision(shouldPrint) {
            document.getElementById('modal-print-confirm').classList.replace('flex', 'hidden');
            if(shouldPrint && lastTransactionId) printStruk(lastTransactionId);
            toast("BERHASIL!", "blue");
            resetKasir();
        }

        function resetKasir() {
            keranjang=[]; 
            document.getElementById('bayarTunai').value=""; 
            document.getElementById('diskonManual').value=""; 
            renderCart();
        }

        function printStruk(id) {
            const t = dataTransaksi.find(x => x.id === id);
            if(!t) return;
            const printArea = document.getElementById('print-area');
            const d = t.waktu?.toDate() || new Date();
            const dateStr = d.toLocaleDateString('id-ID') + ' ' + d.toLocaleTimeString('id-ID');
            printArea.innerHTML = `
                <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:5px; margin-bottom:5px;">
                    <b style="font-size:14px">AMALIA STORE</b><br>POS System
                </div>
                <div style="margin-bottom:5px">Kasir: ${t.kasir}<br>${dateStr}</div>
                <table style="width:100%; border-bottom:1px dashed #000; margin-bottom:5px;">
                    ${t.items.map(i => `<tr><td>${i.nama}<br>${i.qty} ${i.unit} x ${formatIDR(i.hrg)}</td><td style="text-align:right; vertical-align:bottom">${formatIDR(i.sub)}</td></tr>`).join('')}
                </table>
                <table style="width:100%">
                    ${t.diskon ? `<tr><td>Diskon</td><td style="text-align:right">-${formatIDR(t.diskon)}</td></tr>` : ''}
                    <tr><td><b>TOTAL</b></td><td style="text-align:right"><b>${formatIDR(t.total)}</b></td></tr>
                    <tr><td>Tunai</td><td style="text-align:right">${formatIDR(t.bayar)}</td></tr>
                    <tr><td>Kembali</td><td style="text-align:right">${formatIDR(t.kembali)}</td></tr>
                </table>
                <div style="text-align:center; margin-top:10px; border-top:1px dashed #000; padding-top:5px;">Terima Kasih</div>
            `;
            window.print();
        }

        function renderAdminTable(f = '') {
            const res = dataBarang.filter(b => b.nama.toLowerCase().includes(f.toLowerCase()));
            document.getElementById('tabelAdmin').innerHTML = res.map(b => `
                <tr class="hover:bg-white/[0.02]">
                    <td class="p-3">
                        <p class="font-black text-white uppercase">${b.nama}</p>
                    </td>
                    <td class="p-3 font-mono-price text-blue-400">Rp${formatIDR(b.harga)}</td>
                    <td class="p-3"><span class="badge-stok ${b.stok < 10 ? 'badge-stok-low' : ''}">${b.stok}</span></td>
                    <td class="p-3 text-right">
                        <button onclick="openEdit('${b.id}')" class="text-blue-500 mr-2">‚úé</button>
                        <button onclick="deleteBarang('${b.id}')" class="text-red-500">üóë</button>
                    </td>
                </tr>
            `).join('');
        }

        async function simpanBarang() {
            const d = { 
                nama: document.getElementById('admNama').value.toUpperCase(),
                harga: toNum(document.getElementById('admEcer').value),
                hargaBox: toNum(document.getElementById('admGrosir').value),
                stok: parseInt(document.getElementById('admStok').value) || 0
            };
            if(!d.nama || !d.harga) return toast("Lengkapi!", "red");
            await db.collection("barang").add(d);
            document.querySelectorAll('#admForm input').forEach(i => i.value="");
            toast("TERSIPMAN!", "blue");
        }

        function openEdit(id) {
            editingId = id; const b = dataBarang.find(x => x.id === id);
            document.getElementById('editNama').value = b.nama;
            document.getElementById('editEcer').value = formatIDR(b.harga);
            document.getElementById('editGrosir').value = formatIDR(b.hargaBox);
            document.getElementById('editStok').value = b.stok;
            document.getElementById('modal-edit').classList.replace('hidden', 'flex');
        }

        async function updateBarang() {
            await db.collection("barang").doc(editingId).update({
                nama: document.getElementById('editNama').value.toUpperCase(),
                harga: toNum(document.getElementById('editEcer').value),
                hargaBox: toNum(document.getElementById('editGrosir').value),
                stok: parseInt(document.getElementById('editStok').value) || 0
            });
            closeEditModal(); toast("DIUPDATE!", "blue");
        }

        function closeEditModal() { document.getElementById('modal-edit').classList.replace('flex', 'hidden'); }
        async function deleteBarang(id) { if(confirm('Hapus?')) await db.collection("barang").doc(id).delete(); }

        function renderHistory() {
            document.getElementById('history-list').innerHTML = dataTransaksi.map(t => {
                const d = t.waktu?.toDate();
                const fD = d ? d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }) : '-';
                const fT = d ? d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                return `
                <div class="glass-card p-4 rounded-2xl relative overflow-hidden">
                    <div class="flex justify-between items-start border-b border-white/5 pb-2 mb-2">
                        <div>
                            <p class="text-[7px] text-blue-400 font-bold uppercase">Kasir: ${t.kasir}</p>
                            <h3 class="text-[10px] font-black text-white italic">${fD} - ${fT}</h3>
                        </div>
                        <button onclick="printStruk('${t.id}')" class="bg-blue-600/20 text-blue-400 px-2 py-1 rounded text-[8px] font-black">CETAK</button>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-[9px] text-white/60">
                            ${t.items.length} Item ‚Ä¢ ${t.items[0].nama.substring(0,10)}..
                        </div>
                        <div class="text-right">
                            <h2 class="text-xs font-black font-mono-price text-white">Rp${formatIDR(t.total)}</h2>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function updateLaporan() {
            const total = dataTransaksi.reduce((a, b) => a + (b.total || 0), 0);
            document.getElementById('omzet-all').innerText = "Rp " + formatIDR(total);
            document.getElementById('all-count-total').innerText = dataTransaksi.length;
            filterLaporan();
        }

        function filterLaporan() {
            const d = document.getElementById('pick-day').value;
            const m = document.getElementById('pick-month').value;
            let f = dataTransaksi;
            if(d) f = dataTransaksi.filter(t => t.waktu?.toDate().toISOString().split('T')[0] === d);
            else if(m) f = dataTransaksi.filter(t => t.waktu?.toDate().toISOString().slice(0,7) === m);
            const total = f.reduce((a,b) => a + (b.total||0), 0);
            document.getElementById('lap-omzet').innerText = "Rp " + formatIDR(total);
            document.getElementById('lap-count').innerText = f.length;
        }

        window.addEventListener('keydown', (e) => { if(e.key === 'F8') document.getElementById('bayarTunai').focus(); });
    </script>
</body>
</html>
