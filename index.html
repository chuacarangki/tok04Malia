<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMALIA POS PRO - Fixed Price</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #3b82f6; --bg: #020617; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            color: #f8fafc; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            margin: 0; 
        }
        
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .font-mono-price { font-family: 'JetBrains Mono', monospace; }
        
        .custom-scroll { overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(59, 130, 246, 0.3) transparent; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.3); border-radius: 10px; }

        .badge-stok { background: #facc15; color: #000; padding: 2px 8px; border-radius: 6px; font-weight: 800; font-size: 10px; }
        .badge-stok-low { background: #ef4444; color: white; }

        .nav-btn { 
            transition: 0.3s; color: #94a3b8; font-weight: 700; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; flex: 1; font-size: 10px;
        }
        .nav-btn.active { color: #3b82f6; }

        #toast { position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%) scale(0.5); z-index: 9999; opacity: 0; visibility: hidden; transition: 0.4s; width: 90%; max-width: 320px; }
        #toast.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }

        input, button { touch-action: manipulation; min-height: 48px; }
        input { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.15); color: white; outline: none; padding: 0 16px; }
        
        @media (max-width: 768px) {
            .section-page { height: calc(100vh - 64px); padding-bottom: 20px; }
            /* Memastikan dropdown pencarian berada di paling depan di HP */
            #dropdownSearch { 
                position: fixed; 
                top: 135px; 
                left: 12px; 
                right: 12px; 
                z-index: 9999; 
                max-height: 50vh; 
                background: #1e293b;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            }
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 58mm; color: black; background: white; }
        }
    </style>
</head>
<body>

    <div id="print-area" class="hidden font-mono text-[10px] w-[58mm]"></div>

    <div id="toast">
        <div id="toast-inner" class="glass-card px-6 py-4 rounded-2xl border-t-4 border-blue-500 shadow-2xl text-center">
            <div id="toast-text" class="text-xs font-black uppercase text-white"></div>
        </div>
    </div>

    <div id="login-page" class="fixed inset-0 z-[1000] bg-[#020617] flex items-center justify-center p-6">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-xs text-center">
            <h1 class="text-4xl font-black italic text-blue-500 mb-1">AMALIA</h1>
            <p class="text-[8px] font-bold text-slate-500 uppercase tracking-[0.3em] mb-8">Point of Sale</p>
            <input type="text" id="inNamaUser" placeholder="NAMA PETUGAS" class="w-full rounded-2xl text-center font-black uppercase mb-4">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="attemptLogin('Kasir')" class="bg-white/5 rounded-xl font-bold text-[10px] uppercase">KASIR</button>
                <button onclick="attemptLogin('Admin')" class="bg-blue-600 rounded-xl font-bold text-[10px] uppercase">ADMIN</button>
            </div>
        </div>
    </div>

    <header class="p-4 flex justify-between items-center glass-card border-b border-white/5 z-[60]">
        <div class="flex items-center gap-2">
            <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center font-black italic text-white text-sm">A</div>
            <h1 class="text-sm font-black italic text-white">AMALIA</h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right">
                <p id="user-info" class="text-[9px] font-black uppercase text-white leading-none"></p>
                <p id="role-info" class="text-[7px] font-bold text-blue-500 uppercase"></p>
            </div>
            <button onclick="location.reload()" class="text-red-500 font-bold text-lg px-2">‚úï</button>
        </div>
    </header>

    <main id="main-container" class="flex-grow overflow-hidden relative">
        <div id="sec-kasir" class="section-page h-full flex flex-col lg:flex-row">
            <div class="flex-grow flex flex-col p-3 overflow-hidden">
                <div class="relative mb-3 z-[70]">
                    <input type="text" id="inCari" oninput="searchBarang(this.value)" placeholder="Cari Nama Produk..." class="w-full rounded-xl font-bold text-sm h-14">
                    <div id="dropdownSearch" class="glass-card rounded-xl mt-1 overflow-y-auto custom-scroll hidden"></div>
                </div>
                
                <div class="glass-card rounded-2xl flex-grow flex flex-col overflow-hidden">
                    <div class="overflow-y-auto flex-grow custom-scroll">
                        <table class="w-full text-left">
                            <thead class="bg-slate-900/90 sticky top-0 text-[10px] font-bold uppercase text-slate-500 z-10">
                                <tr>
                                    <th class="p-3">Item</th>
                                    <th class="p-3 text-center">Qty</th>
                                    <th class="p-3 text-right">Sub</th>
                                    <th class="p-3"></th>
                                </tr>
                            </thead>
                            <tbody id="tabelKasir" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="side-panel" class="w-full lg:w-80 p-3 glass-card border-t border-white/10 flex flex-col gap-3 shrink-0">
                <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-4 rounded-xl">
                    <p class="text-[10px] font-bold uppercase opacity-70">Total Bayar</p>
                    <h1 id="totalBelanja" class="text-3xl font-black font-mono-price tracking-tighter">Rp 0</h1>
                </div>
                
                <div class="space-y-3">
                    <div class="relative">
                        <label class="absolute left-4 top-2 text-[10px] font-bold text-orange-400 uppercase">Diskon (Rp)</label>
                        <input type="text" id="diskonManual" oninput="formatMoneyInput(this); renderCart()" class="w-full pt-6 pb-2 rounded-xl text-lg font-bold text-orange-400" placeholder="0">
                    </div>
                    <div class="relative">
                        <label class="absolute left-4 top-2 text-[10px] font-bold text-blue-400 uppercase">Tunai / Bayar</label>
                        <input type="text" id="bayarTunai" oninput="formatMoneyInput(this); hitungKembali()" class="w-full pt-6 pb-2 rounded-xl text-xl font-black text-white" placeholder="0">
                    </div>
                </div>

                <div class="p-3 bg-slate-900/50 rounded-xl flex justify-between items-center border border-white/5">
                    <span class="text-[10px] text-slate-500 font-bold uppercase">Kembalian</span>
                    <span id="kembalianText" class="text-lg font-black text-green-400 font-mono-price">Rp 0</span>
                </div>
                <button onclick="prosesBayar()" class="w-full bg-blue-600 h-16 rounded-2xl font-black text-lg uppercase shadow-xl active:scale-95 transition-transform">Proses Bayar</button>
            </div>
        </div>

        <div id="sec-history" class="section-page hidden h-full overflow-y-auto p-4"><div class="max-w-md mx-auto space-y-3" id="history-list"></div></div>
        
        <div id="sec-laporan" class="section-page hidden h-full overflow-y-auto p-4">
             <div class="max-w-md mx-auto space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="glass-card p-4 rounded-xl border-l-4 border-blue-500">
                        <p class="text-[8px] text-blue-400 font-black uppercase text-center">Omzet Total</p>
                        <h1 id="omzet-all" class="text-sm font-black font-mono-price text-center">Rp 0</h1>
                    </div>
                    <div class="glass-card p-4 rounded-xl border-l-4 border-emerald-500">
                        <p class="text-[8px] text-slate-500 font-black uppercase text-center">Total Trx</p>
                        <h1 id="all-count-total" class="text-sm font-black text-center">0</h1>
                    </div>
                </div>
                <div class="glass-card p-4 rounded-xl space-y-3">
                    <div class="flex gap-2">
                        <input type="date" id="pick-day" onchange="filterLaporan()" class="flex-1 rounded-lg text-xs font-bold">
                        <input type="month" id="pick-month" onchange="filterLaporan()" class="flex-1 rounded-lg text-xs font-bold">
                    </div>
                    <div class="border-t border-white/5 pt-3 flex justify-between items-center">
                        <p class="text-[10px] text-yellow-500 font-bold uppercase">Hasil: <span id="lap-count" class="text-white">0</span></p>
                        <h2 id="lap-omzet" class="text-lg font-black font-mono-price text-blue-400">Rp 0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-admin" class="section-page hidden h-full overflow-y-auto p-4">
            <div class="max-w-md mx-auto space-y-6">
                <div class="glass-card p-5 rounded-2xl">
                    <h2 class="text-xs font-black uppercase mb-4 text-blue-400 italic">Data Produk Baru</h2>
                    <div class="grid grid-cols-1 gap-3">
                        <input type="text" id="admNama" placeholder="NAMA BARANG" class="w-full rounded-xl font-black uppercase">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="admEcer" oninput="formatMoneyInput(this)" placeholder="HARGA ECER" class="w-full rounded-xl font-mono-price">
                            <input type="text" id="admGrosir" oninput="formatMoneyInput(this)" placeholder="HARGA BOX" class="w-full rounded-xl font-mono-price">
                        </div>
                        <input type="number" id="admStok" placeholder="STOK AWAL" class="w-full rounded-xl font-bold">
                        <button onclick="simpanBarang()" class="w-full bg-blue-600 rounded-xl font-bold uppercase">Simpan Barang</button>
                    </div>
                </div>
                <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="p-3 border-b border-white/5"><input type="text" oninput="renderAdminTable(this.value)" placeholder="CARI DATABASE..." class="w-full rounded-xl uppercase text-xs"></div>
                    <div class="overflow-x-auto"><table class="w-full text-[10px]"><tbody id="tabelAdmin" class="divide-y divide-white/5"></tbody></table></div>
                </div>
            </div>
        </div>
    </main>

    <nav id="main-nav" class="hidden glass-card border-t border-white/10 h-16 flex items-center justify-around z-[100]">
        <button id="nav-kasir" onclick="showSection('kasir')" class="nav-btn active"><span class="text-xl">üõí</span><span>KASIR</span></button>
        <button id="nav-history" onclick="showSection('history')" class="nav-btn"><span class="text-xl">üïí</span><span>HISTORY</span></button>
        <button id="nav-laporan" onclick="showSection('laporan')" class="nav-btn"><span class="text-xl">üìä</span><span>LAPORAN</span></button>
        <button id="nav-admin" onclick="showSection('admin')" class="nav-btn hidden !text-orange-400"><span class="text-xl">‚öôÔ∏è</span><span>ADMIN</span></button>
    </nav>

    <div id="modal-pass" class="fixed inset-0 z-[1001] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-card p-8 rounded-[35px] w-full max-w-xs text-center">
            <h2 class="text-xs font-bold mb-4 text-white uppercase tracking-widest">PIN Admin</h2>
            <input type="password" id="admin-pass-input" class="w-full rounded-xl mb-4 text-center text-3xl font-bold tracking-[0.5em]">
            <button onclick="checkAdminPass()" class="w-full bg-blue-600 rounded-xl font-bold uppercase">Akses</button>
            <button onclick="closePassModal()" class="mt-4 text-[10px] text-slate-500 font-bold uppercase w-full">Kembali</button>
        </div>
    </div>

    <div id="modal-print-confirm" class="fixed inset-0 z-[1010] bg-black/95 hidden items-center justify-center p-6">
        <div class="glass-card p-8 rounded-[40px] w-full max-w-xs text-center">
            <h2 class="text-xl font-black text-white uppercase mb-4">BERHASIL!</h2>
            <p class="text-slate-400 font-bold text-xs mb-6 uppercase">Cetak Struk Sekarang?</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="handlePrintDecision(true)" class="bg-blue-600 rounded-2xl font-black uppercase">YA</button>
                <button onclick="handlePrintDecision(false)" class="bg-white/5 rounded-2xl font-black uppercase">TIDAK</button>
            </div>
        </div>
    </div>

    <div id="modal-edit" class="fixed inset-0 z-[1005] bg-black/90 hidden items-center justify-center p-6 backdrop-blur-md">
        <div class="glass-card p-6 rounded-3xl w-full max-w-sm">
            <h2 class="text-sm font-black mb-4 text-blue-400 uppercase italic">Edit Produk</h2>
            <div class="space-y-3">
                <input type="text" id="editNama" class="w-full rounded-xl font-bold uppercase text-sm">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="editEcer" oninput="formatMoneyInput(this)" class="rounded-xl text-sm font-mono-price" placeholder="Ecer">
                    <input type="text" id="editGrosir" oninput="formatMoneyInput(this)" class="rounded-xl text-sm font-mono-price" placeholder="Box">
                </div>
                <input type="number" id="editStok" class="w-full rounded-xl font-bold text-sm" placeholder="Stok">
                <button onclick="updateBarang()" class="w-full bg-blue-600 rounded-xl font-black uppercase">Simpan</button>
                <button onclick="closeEditModal()" class="w-full text-slate-500 text-xs font-bold uppercase">Batal</button>
            </div>
        </div>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyBhrN6vuBzuxwFgPI-iXJky6ErDz8auclY",
            authDomain: "toko4malia.firebaseapp.com",
            projectId: "toko4malia",
            storageBucket: "toko4malia.firebasestorage.app",
            messagingSenderId: "1053922856540",
            appId: "1:1053922856540:web:34f5e6de7d5538b1e66099"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();

        let dataBarang = [], dataTransaksi = [], keranjang = [], userAktif = '', userRole = '', editingId = null, lastTransactionId = null;

        const formatIDR = (n) => new Intl.NumberFormat('id-ID').format(n || 0);
        
        // FIXED toNum: Mendeteksi apakah input sudah angka atau string berformat
        const toNum = (val) => {
            if (val === undefined || val === null || val === "") return 0;
            if (typeof val === 'number') return val;
            let str = val.toString().replace(/\./g, '').replace(/[^0-9]/g, '');
            return parseInt(str) || 0;
        };

        function formatMoneyInput(el) {
            let v = toNum(el.value);
            el.value = v === 0 ? "" : formatIDR(v);
        }

        function toast(msg, type = 'blue') {
            const t = document.getElementById('toast');
            const txt = document.getElementById('toast-text');
            const inner = document.getElementById('toast-inner');
            inner.style.borderColor = type === 'red' ? '#ef4444' : '#3b82f6';
            txt.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        function attemptLogin(role) {
            const name = document.getElementById('inNamaUser').value;
            if(!name) return toast("Isi Nama!", "red");
            if(role === 'Admin') document.getElementById('modal-pass').classList.replace('hidden', 'flex');
            else loginSuccess(name, 'Kasir');
        }

        function checkAdminPass() {
            if(document.getElementById('admin-pass-input').value === '1212') {
                loginSuccess(document.getElementById('inNamaUser').value, 'Admin');
                closePassModal();
            } else { toast("PIN SALAH!", "red"); }
        }

        function loginSuccess(name, role) {
            userAktif = name; userRole = role;
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-nav').classList.replace('hidden', 'flex');
            document.getElementById('user-info').innerText = name;
            document.getElementById('role-info').innerText = role;
            if(role === 'Admin') document.getElementById('nav-admin').classList.remove('hidden');
            showSection('kasir'); syncData();
        }

        function closePassModal() { document.getElementById('modal-pass').classList.replace('flex', 'hidden'); }

        function syncData() {
            db.collection("barang").onSnapshot(snap => {
                dataBarang = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAdminTable();
            });
            db.collection("transaksi").orderBy("waktu", "desc").onSnapshot(snap => {
                dataTransaksi = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderHistory(); updateLaporan();
            });
        }

        function showSection(id) {
            document.querySelectorAll('.section-page').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('sec-' + id).classList.remove('hidden');
            document.getElementById('nav-' + id).classList.add('active');
        }

        function searchBarang(q) {
            const drop = document.getElementById('dropdownSearch');
            if(!q) { drop.classList.add('hidden'); return; }
            const filtered = dataBarang.filter(b => b.nama.toLowerCase().includes(q.toLowerCase()));
            
            drop.innerHTML = filtered.map(b => `
                <div onclick="addToCart('${b.id}')" class="p-4 border-b border-white/10 flex justify-between items-center active:bg-blue-600 transition-colors">
                    <div class="flex-1">
                        <p class="text-sm font-bold uppercase text-white">${b.nama}</p>
                        <p class="text-xs text-blue-400 font-mono-price">Rp ${formatIDR(b.ecer)}</p>
                    </div>
                    <div class="text-right">
                        <span class="badge-stok ${b.stok < 5 ? 'badge-stok-low' : ''}">${b.stok}</span>
                    </div>
                </div>
            `).join('');
            drop.classList.remove('hidden');
        }

        function addToCart(id) {
            const item = dataBarang.find(b => b.id === id);
            const inCart = keranjang.find(k => k.id === id);
            if(inCart) {
                if(inCart.qty >= item.stok) return toast("Stok Habis!", "red");
                inCart.qty++;
            } else {
                if(item.stok <= 0) return toast("Stok Kosong!", "red");
                keranjang.push({ ...item, qty: 1 });
            }
            document.getElementById('inCari').value = '';
            document.getElementById('dropdownSearch').classList.add('hidden');
            renderCart();
        }

        function renderCart() {
            const tbody = document.getElementById('tabelKasir');
            let total = 0;
            tbody.innerHTML = keranjang.map((k, i) => {
                const sub = k.qty * k.ecer;
                total += sub;
                return `
                    <tr>
                        <td class="p-3">
                            <p class="font-bold uppercase leading-tight text-white">${k.nama}</p>
                            <p class="text-[9px] text-slate-400 font-mono-price">@${formatIDR(k.ecer)}</p>
                        </td>
                        <td class="p-3">
                            <div class="flex items-center justify-center gap-3">
                                <button onclick="updateQty(${i}, -1)" class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center font-bold">-</button>
                                <span class="font-bold text-sm min-w-[20px] text-center">${k.qty}</span>
                                <button onclick="updateQty(${i}, 1)" class="w-8 h-8 bg-blue-600/20 text-blue-400 rounded-lg flex items-center justify-center font-bold">+</button>
                            </div>
                        </td>
                        <td class="p-3 text-right font-mono-price text-xs">Rp ${formatIDR(sub)}</td>
                        <td class="p-3 text-right"><button onclick="keranjang.splice(${i},1);renderCart()" class="text-red-500 text-lg">‚úï</button></td>
                    </tr>
                `;
            }).join('');

            const diskon = toNum(document.getElementById('diskonManual').value);
            const grandTotal = Math.max(0, total - diskon);
            document.getElementById('totalBelanja').innerText = `Rp ${formatIDR(grandTotal)}`;
            hitungKembali();
        }

        function updateQty(idx, n) {
            const item = keranjang[idx];
            const original = dataBarang.find(b => b.id === item.id);
            if(n > 0 && item.qty >= original.stok) return toast("Maks stok!", "red");
            item.qty += n;
            if(item.qty <= 0) keranjang.splice(idx, 1);
            renderCart();
        }

        function hitungKembali() {
            const total = toNum(document.getElementById('totalBelanja').innerText);
            const bayar = toNum(document.getElementById('bayarTunai').value);
            const kembalian = bayar - total;
            document.getElementById('kembalianText').innerText = `Rp ${formatIDR(Math.max(0, kembalian))}`;
        }

        async function prosesBayar() {
            const total = toNum(document.getElementById('totalBelanja').innerText);
            const bayar = toNum(document.getElementById('bayarTunai').value);
            if(total <= 0) return toast("Keranjang Kosong!", "red");
            if(bayar < total) return toast("Uang Kurang!", "red");

            try {
                const batch = db.batch();
                const trxRef = db.collection('transaksi').doc();
                const diskon = toNum(document.getElementById('diskonManual').value);
                
                const dataTrx = {
                    waktu: new Date().getTime(),
                    items: keranjang,
                    total: total,
                    diskon: diskon,
                    bayar: bayar,
                    kasir: userAktif,
                    idTrx: 'TRX-' + Date.now().toString().slice(-6)
                };

                batch.set(trxRef, dataTrx);
                keranjang.forEach(k => {
                    const ref = db.collection('barang').doc(k.id);
                    batch.update(ref, { stok: firebase.firestore.FieldValue.increment(-k.qty) });
                });

                await batch.commit();
                lastTransactionId = trxRef.id;
                document.getElementById('modal-print-confirm').classList.replace('hidden', 'flex');
                
                keranjang = [];
                document.getElementById('bayarTunai').value = '';
                document.getElementById('diskonManual').value = '';
                renderCart();
            } catch(e) { toast("Sistem Error!", "red"); }
        }

        function handlePrintDecision(yes) {
            document.getElementById('modal-print-confirm').classList.replace('flex', 'hidden');
            if(yes) cetakStruk(lastTransactionId);
        }

        function cetakStruk(id) {
            const trx = dataTransaksi.find(t => t.id === id);
            if(!trx) return;
            const area = document.getElementById('print-area');
            area.innerHTML = `
                <div style="text-align:center; padding:10px 0;">
                    <h2 style="font-size:16px; margin:0">AMALIA STORE</h2>
                </div>
                <div style="border-bottom:1px dashed black;"></div>
                <div style="font-size:10px; padding:5px 0;">
                    <p>TRX: ${trx.idTrx} | ${trx.kasir}</p>
                    <p>${new Date(trx.waktu).toLocaleString()}</p>
                </div>
                <div style="border-bottom:1px dashed black;"></div>
                <div style="padding:5px 0;">
                ${trx.items.map(i => `
                    <div style="display:flex; justify-content:space-between; font-size:10px;">
                        <span>${i.nama} x${i.qty}</span>
                        <span>${formatIDR(i.qty * i.ecer)}</span>
                    </div>
                `).join('')}
                </div>
                <div style="border-bottom:1px dashed black;"></div>
                <div style="padding:5px 0; font-size:11px;">
                    <div style="display:flex; justify-content:space-between;"><span>TOTAL</span><span>Rp ${formatIDR(trx.total)}</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>TUNAI</span><span>Rp ${formatIDR(trx.bayar)}</span></div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>KEMBALI</span><span>Rp ${formatIDR(trx.bayar - trx.total)}</span></div>
                </div>
            `;
            window.print();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = dataTransaksi.map(t => `
                <div class="glass-card p-4 rounded-2xl flex justify-between items-center border-l-4 border-blue-500">
                    <div>
                        <p class="text-xs font-black text-white">${t.idTrx}</p>
                        <p class="text-[10px] text-slate-400">${new Date(t.waktu).toLocaleTimeString()}</p>
                    </div>
                    <div class="text-right flex items-center gap-4">
                        <p class="text-sm font-black font-mono-price text-blue-400">Rp ${formatIDR(t.total)}</p>
                        <button onclick="cetakStruk('${t.id}')" class="p-2 bg-white/5 rounded-lg">üñ®Ô∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function updateLaporan() {
            const totalOmzet = dataTransaksi.reduce((a, b) => a + b.total, 0);
            document.getElementById('omzet-all').innerText = `Rp ${formatIDR(totalOmzet)}`;
            document.getElementById('all-count-total').innerText = dataTransaksi.length;
            filterLaporan();
        }

        function filterLaporan() {
            const day = document.getElementById('pick-day').value;
            const month = document.getElementById('pick-month').value;
            let filtered = dataTransaksi;
            if(day) filtered = filtered.filter(t => new Date(t.waktu).toISOString().split('T')[0] === day);
            else if(month) filtered = filtered.filter(t => new Date(t.waktu).toISOString().slice(0, 7) === month);
            const total = filtered.reduce((a, b) => a + b.total, 0);
            document.getElementById('lap-count').innerText = filtered.length;
            document.getElementById('lap-omzet').innerText = `Rp ${formatIDR(total)}`;
        }

        async function simpanBarang() {
            const nama = document.getElementById('admNama').value;
            const ecer = toNum(document.getElementById('admEcer').value);
            const grosir = toNum(document.getElementById('admGrosir').value);
            const stok = parseInt(document.getElementById('admStok').value);
            if(!nama || !ecer) return toast("Lengkapi Data!", "red");
            try {
                await db.collection('barang').add({ nama: nama.toUpperCase(), ecer, grosir, stok: stok || 0 });
                toast("Barang Tersimpan");
                document.getElementById('admNama').value = ''; 
                document.getElementById('admEcer').value = '';
                document.getElementById('admGrosir').value = ''; 
                document.getElementById('admStok').value = '';
            } catch(e) { toast("Error Simpan", "red"); }
        }

        function renderAdminTable(q = '') {
            const tbody = document.getElementById('tabelAdmin');
            const filtered = dataBarang.filter(b => b.nama.toLowerCase().includes(q.toLowerCase()));
            tbody.innerHTML = filtered.map(b => `
                <tr class="active:bg-blue-600/20">
                    <td class="p-4"><p class="font-bold uppercase text-white">${b.nama}</p></td>
                    <td class="p-4 font-mono-price">Rp ${formatIDR(b.ecer)}</td>
                    <td class="p-4 text-center font-bold">${b.stok}</td>
                    <td class="p-4 text-right">
                        <button onclick="openEdit('${b.id}')" class="text-blue-400 mr-4">‚úé</button>
                        <button onclick="hapusBarang('${b.id}')" class="text-red-500">‚úï</button>
                    </td>
                </tr>
            `).join('');
        }

        function openEdit(id) {
            const b = dataBarang.find(x => x.id === id);
            editingId = id;
            document.getElementById('editNama').value = b.nama;
            document.getElementById('editEcer').value = formatIDR(b.ecer);
            document.getElementById('editGrosir').value = formatIDR(b.grosir);
            document.getElementById('editStok').value = b.stok;
            document.getElementById('modal-edit').classList.replace('hidden', 'flex');
        }

        async function updateBarang() {
            const data = {
                nama: document.getElementById('editNama').value.toUpperCase(),
                ecer: toNum(document.getElementById('editEcer').value),
                grosir: toNum(document.getElementById('editGrosir').value),
                stok: parseInt(document.getElementById('editStok').value)
            };
            await db.collection('barang').doc(editingId).update(data);
            closeEditModal(); toast("Data Diperbarui");
        }

        function closeEditModal() { document.getElementById('modal-edit').classList.replace('flex', 'hidden'); }

        async function hapusBarang(id) {
            if(confirm("Hapus barang dari database?")) {
                await db.collection('barang').doc(id).delete();
                toast("Berhasil Dihapus", "red");
            }
        }
    </script>
</body>
</html>
