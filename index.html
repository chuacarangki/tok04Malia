<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMALIA POS - Simple Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .custom-scroll { overflow-y: auto; }
        input { background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; outline: none; }
        #dropdownSearch { position: absolute; width: 100%; top: 60px; z-index: 100; background: #1e293b; border-radius: 8px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="login-page" class="fixed inset-0 z-[1000] bg-[#020617] flex items-center justify-center p-6">
        <div class="glass-card p-8 rounded-3xl w-full max-w-xs text-center">
            <h1 class="text-3xl font-black text-blue-500 mb-6 italic">AMALIA</h1>
            <input type="text" id="inNamaUser" placeholder="NAMA PETUGAS" class="w-full mb-4 uppercase font-bold text-center">
            <button onclick="login()" class="w-full bg-blue-600 h-12 rounded-xl font-bold">MASUK KASIR</button>
        </div>
    </div>

    <header class="p-4 glass-card flex justify-between items-center">
        <h1 class="font-black italic text-blue-500">AMALIA STORE</h1>
        <div id="user-display" class="text-[10px] font-bold uppercase"></div>
    </header>

    <main class="flex-grow flex flex-col p-3 overflow-hidden relative">
        <div class="relative mb-3">
            <input type="text" id="inCari" oninput="cariBarang(this.value)" placeholder="Cari Nama Produk..." class="w-full h-12 text-sm font-bold">
            <div id="dropdownSearch" class="hidden shadow-2xl"></div>
        </div>

        <div class="flex-grow glass-card rounded-xl overflow-hidden flex flex-col">
            <div class="custom-scroll flex-grow">
                <table class="w-full text-xs">
                    <thead class="bg-slate-800 sticky top-0">
                        <tr><th class="p-3 text-left">ITEM</th><th class="p-3 text-center">QTY</th><th class="p-3 text-right">TOTAL</th></tr>
                    </thead>
                    <tbody id="tabelKasir"></tbody>
                </table>
            </div>
        </div>

        <div class="mt-3 space-y-2">
            <div class="glass-card p-4 rounded-xl bg-blue-900/30">
                <p class="text-[10px] font-bold uppercase opacity-60">Total Belanja</p>
                <h1 id="totalHarga" class="text-3xl font-black">0</h1>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <input type="number" id="bayarTunai" oninput="hitungKembali()" placeholder="UANG BAYAR" class="h-12 font-bold text-lg">
                <div class="glass-card flex items-center justify-center rounded-lg">
                    <span class="text-[10px] mr-2">KEMBALI:</span>
                    <span id="kembalian" class="font-bold text-green-400">0</span>
                </div>
            </div>
            <button onclick="prosesSimpan()" class="w-full bg-blue-600 h-14 rounded-xl font-black text-lg">SIMPAN TRANSAKSI</button>
        </div>
    </main>

    <script>
        const config = {
            apiKey: "AIzaSyBhrN6vuBzuxwFgPI-iXJky6ErDz8auclY",
            authDomain: "toko4malia.firebaseapp.com",
            projectId: "toko4malia",
            storageBucket: "toko4malia.firebasestorage.app",
            messagingSenderId: "1053922856540",
            appId: "1:1053922856540:web:34f5e6de7d5538b1e66099"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();

        let dataBarang = [], keranjang = [], userSekarang = '';

        function login() {
            const n = document.getElementById('inNamaUser').value;
            if(!n) return alert("Isi Nama!");
            userSekarang = n;
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('user-display').innerText = n;
            loadBarang();
        }

        function loadBarang() {
            db.collection("barang").onSnapshot(snap => {
                dataBarang = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            });
        }

        function cariBarang(q) {
            const drop = document.getElementById('dropdownSearch');
            if(!q) return drop.classList.add('hidden');
            
            const hasil = dataBarang.filter(b => b.nama.toLowerCase().includes(q.toLowerCase()));
            drop.innerHTML = hasil.map(b => `
                <div onclick="tambahItem('${b.id}')" class="p-4 border-b border-white/5 flex justify-between">
                    <div>
                        <div class="font-bold uppercase text-sm">${b.nama}</div>
                        <div class="text-blue-400 text-xs">Harga: ${b.ecer}</div>
                    </div>
                    <div class="text-[10px] bg-yellow-500 text-black px-2 py-1 rounded h-fit">Stok: ${b.stok}</div>
                </div>
            `).join('');
            drop.classList.remove('hidden');
        }

        function tambahItem(id) {
            const b = dataBarang.find(x => x.id === id);
            const ada = keranjang.find(k => k.id === id);
            
            if(ada) {
                ada.qty++;
            } else {
                keranjang.push({ id: b.id, nama: b.nama, ecer: Number(b.ecer), qty: 1 });
            }
            
            document.getElementById('inCari').value = '';
            document.getElementById('dropdownSearch').classList.add('hidden');
            updateTabel();
        }

        function updateTabel() {
            const tbody = document.getElementById('tabelKasir');
            let total = 0;
            
            tbody.innerHTML = keranjang.map((k, i) => {
                const sub = k.qty * k.ecer;
                total += sub;
                return `
                    <tr class="border-b border-white/5">
                        <td class="p-3 uppercase font-bold">${k.nama}<br><span class="text-[9px] font-normal opacity-50">@${k.ecer}</span></td>
                        <td class="p-3 text-center">
                            <button onclick="ubahQty(${i},-1)" class="px-2 bg-slate-700 rounded">-</button>
                            <span class="mx-2">${k.qty}</span>
                            <button onclick="ubahQty(${i},1)" class="px-2 bg-blue-600 rounded">+</button>
                        </td>
                        <td class="p-3 text-right font-bold">${sub}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('totalHarga').innerText = total;
            hitungKembali();
        }

        function ubahQty(i, n) {
            keranjang[i].qty += n;
            if(keranjang[i].qty <= 0) keranjang.splice(i, 1);
            updateTabel();
        }

        function hitungKembali() {
            const t = Number(document.getElementById('totalHarga').innerText);
            const b = Number(document.getElementById('bayarTunai').value);
            document.getElementById('kembalian').innerText = b - t;
        }

        async function prosesSimpan() {
            const t = Number(document.getElementById('totalHarga').innerText);
            const b = Number(document.getElementById('bayarTunai').value);
            
            if(t <= 0) return alert("Keranjang Kosong!");
            if(b < t) return alert("Uang Kurang!");

            try {
                const batch = db.batch();
                const ref = db.collection("transaksi").doc();
                
                batch.set(ref, {
                    waktu: Date.now(),
                    items: keranjang,
                    total: t,
                    kasir: userSekarang
                });

                keranjang.forEach(k => {
                    batch.update(db.collection("barang").doc(k.id), {
                        stok: firebase.firestore.FieldValue.increment(-k.qty)
                    });
                });

                await batch.commit();
                alert("TRANSAKSI BERHASIL DISIMPAN!");
                keranjang = [];
                document.getElementById('bayarTunai').value = '';
                updateTabel();
            } catch(e) {
                alert("Gagal Simpan Database!");
            }
        }
    </script>
</body>
</html>
