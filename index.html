<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMALIA POS PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; margin: 0; overflow: hidden; height: 100vh; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-nav { flex: 1; text-align: center; padding: 12px; font-size: 10px; font-weight: 800; color: #94a3b8; transition: 0.3s; }
        .btn-nav.active { color: #3b82f6; border-bottom: 3px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
        input, select { background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; outline: none; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        #dropdownSearch { position: absolute; width: 100%; top: 60px; z-index: 100; max-height: 50vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="login-page" class="fixed inset-0 z-[2000] bg-[#020617] flex items-center justify-center p-6">
        <div class="glass p-8 rounded-[2rem] w-full max-w-sm text-center">
            <h1 class="text-4xl font-black italic text-blue-500 mb-2">AMALIA</h1>
            <p class="text-[10px] tracking-[0.3em] mb-8 text-slate-500 font-bold uppercase">Management System</p>
            <input type="text" id="inNamaUser" placeholder="NAMA PETUGAS" class="w-full mb-4 text-center font-bold uppercase">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="attemptLogin('Kasir')" class="bg-slate-800 h-12 rounded-xl font-bold uppercase text-xs">Kasir</button>
                <button onclick="attemptLogin('Admin')" class="bg-blue-600 h-12 rounded-xl font-bold uppercase text-xs">Admin</button>
            </div>
        </div>
    </div>

    <nav id="navbar" class="hidden glass flex border-b border-white/5 z-50">
        <div onclick="showTab('kasir')" id="tab-kasir" class="btn-nav active">üõí KASIR</div>
        <div onclick="showTab('history')" id="tab-history" class="btn-nav">üïí HISTORY</div>
        <div onclick="showTab('laporan')" id="tab-laporan" class="btn-nav">üìä LAPORAN</div>
        <div onclick="openAdmin()" id="tab-admin" class="btn-nav text-orange-400">‚öôÔ∏è ADMIN</div>
    </nav>

    <main id="content" class="hidden flex-grow relative overflow-hidden h-[calc(100vh-60px)]">
        
        <section id="sec-kasir" class="h-full flex flex-col p-3">
            <div class="relative mb-3">
                <input type="text" id="inCari" oninput="searchProduct(this.value)" placeholder="Ketik nama barang..." class="w-full h-14 font-bold uppercase">
                <div id="dropdownSearch" class="hidden glass rounded-xl divide-y divide-white/5 overflow-hidden"></div>
            </div>

            <div class="flex-grow glass rounded-2xl overflow-hidden flex flex-col mb-3">
                <div class="flex-grow overflow-y-auto custom-scroll">
                    <table class="w-full text-xs">
                        <thead class="bg-slate-900/90 sticky top-0 uppercase font-bold text-slate-500">
                            <tr><th class="p-3 text-left">Produk</th><th class="p-3 text-center">Qty</th><th class="p-3 text-right">Subtotal</th><th class="p-3"></th></tr>
                        </thead>
                        <tbody id="cartTable" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>

            <div class="glass p-4 rounded-2xl space-y-3">
                <div class="flex justify-between items-end">
                    <div><p class="text-[10px] font-bold text-slate-500 uppercase">Total Bayar</p><h1 id="cartTotal" class="text-3xl font-black">Rp 0</h1></div>
                    <div class="text-right"><p class="text-[10px] font-bold text-slate-500 uppercase">Kembali</p><h1 id="cartChange" class="text-xl font-black text-green-400">Rp 0</h1></div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="cashInput" oninput="calcChange()" placeholder="Tunai" class="h-12 font-bold text-lg">
                    <button onclick="checkout()" class="bg-blue-600 rounded-xl font-black uppercase">Selesai</button>
                </div>
            </div>
        </section>

        <section id="sec-history" class="hidden h-full p-4 overflow-y-auto custom-scroll">
            <h2 class="font-black mb-4 uppercase text-blue-500 italic">Riwayat Transaksi</h2>
            <div id="historyList" class="space-y-3 pb-20"></div>
        </section>

        <section id="sec-laporan" class="hidden h-full p-4 overflow-y-auto custom-scroll">
            <div class="glass p-4 rounded-2xl mb-4">
                <p class="text-[10px] font-bold uppercase mb-2">Filter Laporan</p>
                <div class="flex gap-2">
                    <input type="date" id="reportDate" class="flex-grow text-xs">
                    <button onclick="loadReports()" class="bg-blue-600 px-4 rounded-lg font-bold text-xs uppercase">Cek</button>
                </div>
            </div>
            <div id="reportSummary" class="grid grid-cols-1 gap-3 mb-6"></div>
            <div id="reportDetail" class="space-y-2 pb-20"></div>
        </section>

        <section id="sec-admin" class="hidden h-full p-4 overflow-y-auto custom-scroll">
            <div class="glass p-5 rounded-2xl mb-6">
                <h3 id="adminFormTitle" class="font-black mb-4 uppercase text-xs text-orange-400">Tambah Barang Baru</h3>
                <div class="grid gap-3">
                    <input type="text" id="admNama" placeholder="NAMA BARANG" class="uppercase font-bold">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="admPcs" placeholder="HARGA PCS">
                        <input type="number" id="admBox" placeholder="HARGA BOX">
                    </div>
                    <input type="number" id="admStok" placeholder="JUMLAH STOK">
                    <input type="hidden" id="admId">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="clearAdminForm()" class="bg-slate-800 h-12 rounded-xl font-bold uppercase text-xs">Reset</button>
                        <button onclick="saveProduct()" id="btnSave" class="bg-orange-600 h-12 rounded-xl font-bold uppercase text-xs">Simpan Barang</button>
                    </div>
                </div>
            </div>
            <div class="glass rounded-2xl overflow-hidden">
                <table class="w-full text-[10px]">
                    <thead class="bg-slate-900">
                        <tr><th class="p-3 text-left">Nama</th><th class="p-3 text-right">Pcs/Box</th><th class="p-3 text-center">Stok</th><th class="p-3">Aksi</th></tr>
                    </thead>
                    <tbody id="adminTable" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="modal-pass" class="fixed inset-0 z-[3000] bg-black/95 hidden items-center justify-center p-6">
        <div class="glass p-8 rounded-3xl w-full max-w-xs text-center">
            <h2 class="font-bold mb-4 uppercase text-xs">Akses Password Admin</h2>
            <input type="password" id="adminPass" class="w-full mb-4 text-center text-2xl tracking-[0.5em]">
            <button onclick="checkAdminPass()" class="w-full bg-blue-600 h-12 rounded-xl font-bold">VERIFIKASI</button>
            <button onclick="closeModal()" class="mt-4 text-[10px] font-bold text-slate-500 uppercase">Batal</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const config = {
            apiKey: "AIzaSyBhrN6vuBzuxwFgPI-iXJky6ErDz8auclY",
            authDomain: "toko4malia.firebaseapp.com",
            projectId: "toko4malia",
            storageBucket: "toko4malia.firebasestorage.app",
            messagingSenderId: "1053922856540",
            appId: "1:1053922856540:web:34f5e6de7d5538b1e66099"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();

        let dataBarang = [], cart = [], currentUser = '', currentRole = '';

        // --- UTILS ---
        const fmt = (n) => "Rp " + (Number(n) || 0).toLocaleString('id-ID');
        const parse = (v) => parseInt(v.toString().replace(/\D/g, '')) || 0;

        // --- AUTH ---
        function attemptLogin(role) {
            const name = document.getElementById('inNamaUser').value;
            if(!name) return alert("NAMA HARUS DIISI");
            currentUser = name;
            if(role === 'Admin') {
                document.getElementById('modal-pass').classList.replace('hidden', 'flex');
            } else {
                loginSuccess('Kasir');
            }
        }

        function checkAdminPass() {
            if(document.getElementById('adminPass').value === '1212') {
                loginSuccess('Admin');
                closeModal();
            } else { alert("PIN SALAH"); }
        }

        function loginSuccess(role) {
            currentRole = role;
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('navbar').classList.replace('hidden', 'flex');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('user-display').innerText = `${currentUser} (${role})`;
            syncData();
        }

        function closeModal() { document.getElementById('modal-pass').classList.replace('flex', 'hidden'); }

        // --- DATABASE SYNC ---
        function syncData() {
            db.collection("barang").onSnapshot(snap => {
                dataBarang = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAdminTable();
            });
            db.collection("transaksi").orderBy("waktu", "desc").onSnapshot(snap => {
                renderHistory(snap.docs.map(d => d.data()));
            });
        }

        // --- NAVIGATION ---
        function showTab(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
            document.getElementById('sec-' + id).classList.remove('hidden');
            document.getElementById('tab-' + id).classList.add('active');
        }

        function openAdmin() {
            if(currentRole !== 'Admin') return alert("HANYA ADMIN YANG BOLEH MASUK");
            showTab('admin');
        }

        // --- KASIR LOGIC ---
        function searchProduct(q) {
            const drop = document.getElementById('dropdownSearch');
            if(!q) return drop.classList.add('hidden');
            const filtered = dataBarang.filter(b => b.nama.toLowerCase().includes(q.toLowerCase()));
            
            drop.innerHTML = filtered.map(b => `
                <div onclick="addToCart('${b.id}')" class="p-4 flex justify-between items-center active:bg-blue-600">
                    <div>
                        <p class="font-bold uppercase text-sm">${b.nama}</p>
                        <p class="text-blue-400 text-xs font-bold">Pcs: ${fmt(b.pcs)} | Box: ${fmt(b.box)}</p>
                    </div>
                    <div class="text-[10px] font-bold bg-yellow-500 text-black px-2 py-1 rounded">STOK: ${b.stok}</div>
                </div>
            `).join('');
            drop.classList.remove('hidden');
        }

        function addToCart(id) {
            const b = dataBarang.find(x => x.id === id);
            const inCart = cart.find(c => c.id === id && c.mode === 'pcs');
            if(inCart) inCart.qty++;
            else cart.push({ id: b.id, nama: b.nama, pcs: b.pcs, box: b.box, qty: 1, mode: 'pcs' });
            
            document.getElementById('inCari').value = '';
            document.getElementById('dropdownSearch').classList.add('hidden');
            renderCart();
        }

        function renderCart() {
            let total = 0;
            document.getElementById('cartTable').innerHTML = cart.map((c, i) => {
                const price = c.mode === 'pcs' ? c.pcs : c.box;
                const sub = c.qty * price;
                total += sub;
                return `
                    <tr>
                        <td class="p-3">
                            <p class="font-bold uppercase">${c.nama}</p>
                            <button onclick="toggleMode(${i})" class="text-[9px] bg-slate-800 px-2 py-1 rounded mt-1 font-bold text-blue-400 uppercase">
                                Mode: ${c.mode} (@${fmt(price)})
                            </button>
                        </td>
                        <td class="p-3 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="updateQty(${i},-1)" class="w-6 h-6 bg-slate-800 rounded">-</button>
                                <span class="font-bold">${c.qty}</span>
                                <button onclick="updateQty(${i},1)" class="w-6 h-6 bg-blue-600 rounded">+</button>
                            </div>
                        </td>
                        <td class="p-3 text-right font-bold">${fmt(sub)}</td>
                        <td onclick="cart.splice(${i},1);renderCart()" class="p-3 text-red-500 font-bold">‚úï</td>
                    </tr>
                `;
            }).join('');
            document.getElementById('cartTotal').innerText = fmt(total);
            calcChange();
        }

        function toggleMode(i) {
            cart[i].mode = cart[i].mode === 'pcs' ? 'box' : 'pcs';
            renderCart();
        }

        function updateQty(i, n) {
            cart[i].qty += n;
            if(cart[i].qty <= 0) cart.splice(i, 1);
            renderCart();
        }

        function calcChange() {
            const total = parse(document.getElementById('cartTotal').innerText);
            const cash = parseInt(document.getElementById('cashInput').value) || 0;
            document.getElementById('cartChange').innerText = fmt(Math.max(0, cash - total));
        }

        async function checkout() {
            const total = parse(document.getElementById('cartTotal').innerText);
            const cash = parseInt(document.getElementById('cashInput').value) || 0;
            if(total <= 0) return alert("KERANJANG KOSONG");
            if(cash < total) return alert("UANG KURANG");

            const batch = db.batch();
            const ref = db.collection("transaksi").doc();
            
            batch.set(ref, {
                waktu: Date.now(),
                items: cart,
                total: total,
                kasir: currentUser,
                idTrx: "TRX" + Date.now().toString().slice(-6)
            });

            cart.forEach(c => {
                batch.update(db.collection("barang").doc(c.id), {
                    stok: firebase.firestore.FieldValue.increment(-c.qty)
                });
            });

            await batch.commit();
            alert("TRANSAKSI BERHASIL");
            cart = []; document.getElementById('cashInput').value = ''; renderCart();
        }

        // --- HISTORY & REPORTS ---
        function renderHistory(docs) {
            document.getElementById('historyList').innerHTML = docs.map(t => `
                <div class="glass p-4 rounded-xl flex justify-between items-center border-l-4 border-blue-500">
                    <div>
                        <p class="text-[10px] font-bold text-blue-400 uppercase">${t.idTrx}</p>
                        <p class="text-xs font-bold uppercase">${new Date(t.waktu).toLocaleString()}</p>
                        <p class="text-[9px] text-slate-500 mt-1 uppercase">Kasir: ${t.kasir}</p>
                    </div>
                    <p class="font-black text-white text-sm">${fmt(t.total)}</p>
                </div>
            `).join('');
        }

        async function loadReports() {
            const dateVal = document.getElementById('reportDate').value;
            if(!dateVal) return alert("PILIH TANGGAL");
            
            const start = new Date(dateVal).setHours(0,0,0,0);
            const end = new Date(dateVal).setHours(23,59,59,999);
            
            const snap = await db.collection("transaksi").where("waktu", ">=", start).where("waktu", "<=", end).get();
            let totalOmzet = 0;
            let htmlDetail = '';
            
            snap.forEach(d => {
                const t = d.data();
                totalOmzet += t.total;
                htmlDetail += `
                    <div class="glass p-3 rounded-lg flex justify-between text-[10px]">
                        <span>${t.idTrx} - ${t.kasir}</span>
                        <span class="font-bold">${fmt(t.total)}</span>
                    </div>
                `;
            });

            document.getElementById('reportSummary').innerHTML = `
                <div class="glass p-4 rounded-2xl border-l-4 border-emerald-500">
                    <p class="text-[9px] font-bold opacity-50 uppercase">Omzet ${dateVal}</p>
                    <h2 class="text-xl font-black">${fmt(totalOmzet)}</h2>
                </div>
            `;
            document.getElementById('reportDetail').innerHTML = htmlDetail;
        }

        // --- ADMIN LOGIC ---
        async function saveProduct() {
            const nama = document.getElementById('admNama').value.toUpperCase();
            const pcs = parseInt(document.getElementById('admPcs').value) || 0;
            const box = parseInt(document.getElementById('admBox').value) || 0;
            const stok = parseInt(document.getElementById('admStok').value) || 0;
            const id = document.getElementById('admId').value;

            if(!nama || !pcs) return alert("DATA BELUM LENGKAP");

            const data = { nama, pcs, box, stok };
            if(id) {
                await db.collection("barang").doc(id).update(data);
                alert("BARANG DIEDIT");
            } else {
                await db.collection("barang").add(data);
                alert("BARANG DITAMBAH");
            }
            clearAdminForm();
        }

        function editItem(id) {
            const b = dataBarang.find(x => x.id === id);
            document.getElementById('admNama').value = b.nama;
            document.getElementById('admPcs').value = b.pcs;
            document.getElementById('admBox').value = b.box;
            document.getElementById('admStok').value = b.stok;
            document.getElementById('admId').value = b.id;
            document.getElementById('adminFormTitle').innerText = "Edit Barang: " + b.nama;
            document.getElementById('btnSave').innerText = "Update Barang";
        }

        function clearAdminForm() {
            ['admNama','admPcs','admBox','admStok','admId'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('adminFormTitle').innerText = "Tambah Barang Baru";
            document.getElementById('btnSave').innerText = "Simpan Barang";
        }

        function renderAdminTable() {
            document.getElementById('adminTable').innerHTML = dataBarang.map(b => `
                <tr class="hover:bg-white/5">
                    <td class="p-3 uppercase font-bold text-white">${b.nama}</td>
                    <td class="p-3 text-right">
                        <div class="text-blue-400 font-bold">P: ${fmt(b.pcs)}</div>
                        <div class="text-slate-500">B: ${fmt(b.box)}</div>
                    </td>
                    <td class="p-3 text-center font-bold">${b.stok}</td>
                    <td class="p-3 text-right">
                        <button onclick="editItem('${b.id}')" class="text-blue-400 mr-2">‚úèÔ∏è</button>
                        <button onclick="if(confirm('Hapus?')) db.collection('barang').doc('${b.id}').delete()" class="text-red-500">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

    </script>
</body>
</html>
